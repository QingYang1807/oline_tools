<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Markdown 在线编辑器 · 工具箱</title>
  <link rel="stylesheet" href="../assets/css/style.css">
  <link rel="stylesheet" href="../assets/css/markdown-editor.css">
  <meta name="color-scheme" content="light dark">
</head>
<body>
  <header class="site-header">
    <div class="container">
      <h1 class="site-title">📝 Markdown 在线编辑器</h1>
      <p class="site-subtitle">左侧编辑，右侧预览，支持一键导出 PDF</p>
    </div>
  </header>

  <main class="container">
    <div class="editor-container">
      <!-- 工具栏 -->
      <div class="toolbar">
        <div class="toolbar-left">
          <button class="tool-btn" onclick="insertText('**', '**')" title="粗体">
            <strong>B</strong>
          </button>
          <button class="tool-btn" onclick="insertText('*', '*')" title="斜体">
            <em>I</em>
          </button>
          <button class="tool-btn" onclick="insertText('~~', '~~')" title="删除线">
            <del>S</del>
          </button>
          <button class="tool-btn" onclick="insertText('`', '`')" title="行内代码">
            <code>{}</code>
          </button>
          <button class="tool-btn" onclick="insertText('```\n', '\n```')" title="代码块">
            <code>```</code>
          </button>
          <button class="tool-btn" onclick="insertText('- ', '')" title="无序列表">
            •
          </button>
          <button class="tool-btn" onclick="insertText('1. ', '')" title="有序列表">
            1.
          </button>
          <button class="tool-btn" onclick="insertText('> ', '')" title="引用">
            "
          </button>
          <button class="tool-btn" onclick="insertText('# ', '')" title="标题">
            H
          </button>
          <button class="tool-btn" onclick="insertText('[', '](url)')" title="链接">
            🔗
          </button>
          <button class="tool-btn" onclick="insertText('![', '](image-url)')" title="图片">
            🖼️
          </button>
        </div>
        <div class="toolbar-right">
          <button class="tool-btn primary" onclick="exportPDF()" title="导出 PDF">
            📄 PDF
          </button>
          <button class="tool-btn" onclick="downloadMarkdown()" title="下载 Markdown">
            💾 MD
          </button>
          <button class="tool-btn" onclick="clearEditor()" title="清空编辑器">
            🗑️ 清空
          </button>
        </div>
      </div>

      <!-- 编辑器主体 -->
      <div class="editor-main">
        <!-- 左侧编辑区域 -->
        <div class="editor-panel">
          <div class="panel-header">
            <h3>📝 编辑区域</h3>
            <span class="char-count" id="charCount">0 字符</span>
          </div>
          <textarea 
            id="markdownEditor" 
            class="markdown-input" 
            placeholder="在这里输入 Markdown 内容...

# 欢迎使用 Markdown 编辑器

## 功能特性
- ✨ 实时预览
- 📄 PDF 导出
- 💾 本地保存
- 🌙 暗色主题

## 使用说明
1. 左侧输入 Markdown 语法
2. 右侧实时查看效果
3. 点击工具栏按钮快速插入格式
4. 支持导出 PDF 和下载 Markdown 文件

## 快捷键
- `Ctrl + S`: 保存到本地存储
- `Ctrl + Z`: 撤销
- `Ctrl + Y`: 重做

开始编写你的文档吧！"
          ></textarea>
        </div>

        <!-- 右侧预览区域 -->
        <div class="preview-panel">
          <div class="panel-header">
            <h3>👁️ 预览效果</h3>
            <div class="preview-controls">
              <button class="tool-btn small" onclick="togglePreview()" id="togglePreviewBtn">
                👁️ 隐藏
              </button>
            </div>
          </div>
          <div id="previewContent" class="markdown-preview"></div>
        </div>
      </div>
    </div>

    <!-- 返回首页 -->
    <div class="back-home">
      <a href="../index.html" class="back-link">← 返回工具箱首页</a>
    </div>
  </main>

  <footer class="site-footer">
    <div class="container">
      <span>© <span id="year"></span> 工具箱</span>
    </div>
  </footer>

  <!-- 引入 Markdown 解析库 -->
  <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
  <!-- 引入代码高亮库 -->
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
  <!-- 引入 PDF 导出库 -->
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>

  <script>
    // 全局变量
    let editor = null;
    let previewVisible = true;
    let autoSaveTimer = null;

    // 初始化
    document.addEventListener('DOMContentLoaded', function() {
      initializeEditor();
      loadFromLocalStorage();
      setupEventListeners();
      updateYear();
    });

    // 初始化编辑器
    function initializeEditor() {
      editor = document.getElementById('markdownEditor');
      
      // 配置 Marked 选项
      marked.setOptions({
        breaks: true,
        gfm: true,
        headerIds: true,
        mangle: false
      });

      // 自定义渲染器
      const renderer = new marked.Renderer();
      renderer.code = function(code, language) {
        const validLanguage = Prism.languages[language] ? language : 'markup';
        const highlighted = Prism.highlight(code, Prism.languages[validLanguage], validLanguage);
        return `<pre class="language-${validLanguage}"><code class="language-${validLanguage}">${highlighted}</code></pre>`;
      };
      marked.use({ renderer });
    }

    // 设置事件监听器
    function setupEventListeners() {
      editor.addEventListener('input', function() {
        updatePreview();
        updateCharCount();
        autoSave();
      });

      // 快捷键支持
      editor.addEventListener('keydown', function(e) {
        if (e.ctrlKey || e.metaKey) {
          switch(e.key) {
            case 's':
              e.preventDefault();
              saveToLocalStorage();
              showToast('已保存到本地存储');
              break;
            case 'z':
              if (e.shiftKey) {
                e.preventDefault();
                document.execCommand('redo');
              } else {
                e.preventDefault();
                document.execCommand('undo');
              }
              break;
          }
        }
      });
    }

    // 更新预览
    function updatePreview() {
      const markdown = editor.value;
      const preview = document.getElementById('previewContent');
      
      try {
        const html = marked.parse(markdown);
        preview.innerHTML = html;
        
        // 重新应用代码高亮
        if (window.Prism) {
          Prism.highlightAllUnder(preview);
        }
      } catch (error) {
        preview.innerHTML = `<div class="error">解析错误: ${error.message}</div>`;
      }
    }

    // 更新字符计数
    function updateCharCount() {
      const count = editor.value.length;
      const charCount = document.getElementById('charCount');
      charCount.textContent = `${count} 字符`;
    }

    // 插入文本
    function insertText(before, after) {
      const start = editor.selectionStart;
      const end = editor.selectionEnd;
      const text = editor.value;
      const selectedText = text.substring(start, end);
      
      const newText = before + selectedText + after;
      editor.value = text.substring(0, start) + newText + text.substring(end);
      
      // 设置光标位置
      if (selectedText.length === 0) {
        editor.selectionStart = editor.selectionEnd = start + before.length;
      } else {
        editor.selectionStart = start;
        editor.selectionEnd = start + newText.length;
      }
      
      editor.focus();
      updatePreview();
      updateCharCount();
    }

    // 切换预览
    function togglePreview() {
      const previewPanel = document.querySelector('.preview-panel');
      const toggleBtn = document.getElementById('togglePreviewBtn');
      
      if (previewVisible) {
        previewPanel.style.display = 'none';
        toggleBtn.textContent = '👁️ 显示';
        document.querySelector('.editor-main').style.gridTemplateColumns = '1fr';
      } else {
        previewPanel.style.display = 'block';
        toggleBtn.textContent = '👁️ 隐藏';
        document.querySelector('.editor-main').style.gridTemplateColumns = '1fr 1fr';
      }
      
      previewVisible = !previewVisible;
    }

    // 导出 PDF
    function exportPDF() {
      const markdown = editor.value;
      if (!markdown.trim()) {
        showToast('请先输入一些内容');
        return;
      }

      const preview = document.getElementById('previewContent');
      const originalDisplay = preview.style.display;
      
      // 临时显示预览内容
      preview.style.display = 'block';
      
      const opt = {
        margin: [10, 10, 10, 10],
        filename: 'markdown-document.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
      };

      html2pdf().set(opt).from(preview).save().then(() => {
        preview.style.display = originalDisplay;
        showToast('PDF 导出成功！');
      }).catch(error => {
        preview.style.display = originalDisplay;
        showToast('PDF 导出失败: ' + error.message);
        console.error('PDF export error:', error);
      });
    }

    // 下载 Markdown
    function downloadMarkdown() {
      const markdown = editor.value;
      if (!markdown.trim()) {
        showToast('请先输入一些内容');
        return;
      }

      const blob = new Blob([markdown], { type: 'text/markdown;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'document.md';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      showToast('Markdown 文件下载成功！');
    }

    // 清空编辑器
    function clearEditor() {
      if (confirm('确定要清空所有内容吗？此操作不可撤销。')) {
        editor.value = '';
        updatePreview();
        updateCharCount();
        localStorage.removeItem('markdownEditor_content');
        showToast('编辑器已清空');
      }
    }

    // 自动保存
    function autoSave() {
      if (autoSaveTimer) {
        clearTimeout(autoSaveTimer);
      }
      
      autoSaveTimer = setTimeout(() => {
        saveToLocalStorage();
      }, 1000);
    }

    // 保存到本地存储
    function saveToLocalStorage() {
      try {
        localStorage.setItem('markdownEditor_content', editor.value);
        localStorage.setItem('markdownEditor_timestamp', Date.now());
      } catch (error) {
        console.error('保存失败:', error);
      }
    }

    // 从本地存储加载
    function loadFromLocalStorage() {
      try {
        const saved = localStorage.getItem('markdownEditor_content');
        const timestamp = localStorage.getItem('markdownEditor_timestamp');
        
        if (saved && timestamp) {
          const age = Date.now() - parseInt(timestamp);
          const maxAge = 7 * 24 * 60 * 60 * 1000; // 7天
          
          if (age < maxAge) {
            editor.value = saved;
            updatePreview();
            updateCharCount();
            showToast('已恢复上次编辑的内容');
          } else {
            localStorage.removeItem('markdownEditor_content');
            localStorage.removeItem('markdownEditor_timestamp');
          }
        }
      } catch (error) {
        console.error('加载失败:', error);
      }
    }

    // 显示提示
    function showToast(message) {
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.classList.add('show');
      }, 100);
      
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
          document.body.removeChild(toast);
        }, 300);
      }, 3000);
    }

    // 更新年份
    function updateYear() {
      document.getElementById('year').textContent = new Date().getFullYear();
    }
  </script>
</body>
</html>
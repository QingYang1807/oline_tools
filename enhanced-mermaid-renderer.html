<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¢å¼ºç‰ˆ Mermaid äº¤äº’å¼æ¸²æŸ“å™¨</title>
    <script src="https://cdn.jsdelivr.net/npm/@antv/g6@4.8.24/dist/g6.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="mermaid-parser.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
            min-height: 700px;
        }

        .editor-panel {
            padding: 30px;
            background: #f8f9fa;
            border-right: 1px solid #e9ecef;
        }

        .preview-panel {
            padding: 30px;
            background: white;
            position: relative;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
            font-size: 1.1em;
        }

        textarea {
            width: 100%;
            min-height: 400px;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            line-height: 1.5;
            resize: vertical;
            transition: border-color 0.3s ease;
        }

        textarea:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(79, 172, 254, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .examples {
            margin-top: 20px;
        }

        .example-btn {
            margin: 5px;
            padding: 8px 16px;
            background: #e9ecef;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .example-btn:hover {
            background: #dee2e6;
            transform: translateY(-1px);
        }

        .preview-container {
            width: 100%;
            height: 500px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            position: relative;
            overflow: hidden;
            background: #fafafa;
        }

        .preview-container canvas {
            border-radius: 8px;
        }

        .status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 6px;
            font-size: 14px;
            text-align: center;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .interaction-hint {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(79, 172, 254, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            z-index: 1000;
        }

        .legend {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 14px;
        }

        .legend h4 {
            margin-bottom: 10px;
            color: #495057;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            margin-right: 10px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .editor-panel {
                border-right: none;
                border-bottom: 1px solid #e9ecef;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ å¢å¼ºç‰ˆ Mermaid äº¤äº’å¼æ¸²æŸ“å™¨</h1>
            <p>æ”¯æŒèŠ‚ç‚¹ç‚¹å‡»é«˜äº®è¿çº¿ï¼ŒåŸºäº AntV G6 å¼•æ“</p>
        </div>

        <div class="main-content">
            <div class="editor-panel">
                <div class="form-group">
                    <label for="mermaidCode">Mermaid ä»£ç ç¼–è¾‘å™¨</label>
                    <textarea id="mermaidCode" placeholder="åœ¨æ­¤è¾“å…¥æ‚¨çš„ Mermaid ä»£ç ...">graph TD
    A[å¼€å§‹] --> B{æ˜¯å¦ç™»å½•?}
    B -->|æ˜¯| C[æ˜¾ç¤ºä¸»é¡µ]
    B -->|å¦| D[æ˜¾ç¤ºç™»å½•é¡µ]
    D --> E[ç”¨æˆ·ç™»å½•]
    E --> F{ç™»å½•æˆåŠŸ?}
    F -->|æ˜¯| C
    F -->|å¦| G[æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯]
    G --> D
    C --> H[ç»“æŸ]</textarea>
                </div>

                <div class="controls">
                    <button class="btn btn-primary" onclick="renderGraph()">
                        ğŸ”„ æ¸²æŸ“å›¾è¡¨
                    </button>
                    <button class="btn btn-success" onclick="copyAsImage()">
                        ğŸ“‹ å¤åˆ¶ä¸ºå›¾ç‰‡
                    </button>
                    <button class="btn btn-secondary" onclick="downloadImage()">
                        ğŸ’¾ ä¸‹è½½å›¾ç‰‡
                    </button>
                </div>

                <div class="examples">
                    <h4>å¿«é€Ÿç¤ºä¾‹ï¼š</h4>
                    <button class="example-btn" onclick="loadExample('flowchart')">æµç¨‹å›¾</button>
                    <button class="example-btn" onclick="loadExample('sequence')">æ—¶åºå›¾</button>
                    <button class="example-btn" onclick="loadExample('gantt')">ç”˜ç‰¹å›¾</button>
                    <button class="example-btn" onclick="loadExample('class')">ç±»å›¾</button>
                    <button class="example-btn" onclick="loadExample('state')">çŠ¶æ€å›¾</button>
                    <button class="example-btn" onclick="loadExample('complex')">å¤æ‚æµç¨‹å›¾</button>
                </div>

                <div id="status" class="status info" style="display: none;"></div>
            </div>

            <div class="preview-panel">
                <div class="interaction-hint">
                    ğŸ’¡ ç‚¹å‡»èŠ‚ç‚¹å¯é«˜äº®ç›¸å…³è¿çº¿
                </div>
                <div class="preview-container" id="previewContainer">
                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #6c757d;">
                        ç‚¹å‡»"æ¸²æŸ“å›¾è¡¨"å¼€å§‹
                    </div>
                </div>

                <div class="legend">
                    <h4>äº¤äº’è¯´æ˜ï¼š</h4>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #5B8FF9;"></div>
                        <span>æ™®é€šèŠ‚ç‚¹</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ff4d4f;"></div>
                        <span>é«˜äº®èŠ‚ç‚¹</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #b5b5b5;"></div>
                        <span>æ™®é€šè¿çº¿</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ff4d4f;"></div>
                        <span>é«˜äº®è¿çº¿</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let graph = null;
        let currentData = null;

        // ç¤ºä¾‹æ•°æ®
        const examples = {
            flowchart: `graph TD
    A[å¼€å§‹] --> B{æ˜¯å¦ç™»å½•?}
    B -->|æ˜¯| C[æ˜¾ç¤ºä¸»é¡µ]
    B -->|å¦| D[æ˜¾ç¤ºç™»å½•é¡µ]
    D --> E[ç”¨æˆ·ç™»å½•]
    E --> F{ç™»å½•æˆåŠŸ?}
    F -->|æ˜¯| C
    F -->|å¦| G[æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯]
    G --> D
    C --> H[ç»“æŸ]`,

            sequence: `sequenceDiagram
    participant U as ç”¨æˆ·
    participant F as å‰ç«¯
    participant B as åç«¯
    participant D as æ•°æ®åº“
    
    U->>F: ç™»å½•è¯·æ±‚
    F->>B: éªŒè¯ç”¨æˆ·ä¿¡æ¯
    B->>D: æŸ¥è¯¢ç”¨æˆ·æ•°æ®
    D-->>B: è¿”å›ç”¨æˆ·ä¿¡æ¯
    B-->>F: è¿”å›éªŒè¯ç»“æœ
    F-->>U: æ˜¾ç¤ºç™»å½•çŠ¶æ€`,

            gantt: `gantt
    title é¡¹ç›®å¼€å‘è®¡åˆ’
    dateFormat  YYYY-MM-DD
    section éœ€æ±‚åˆ†æ
    éœ€æ±‚æ”¶é›†           :done,    des1, 2024-01-01,2024-01-05
    éœ€æ±‚åˆ†æ           :done,    des2, 2024-01-06, 3d
    section è®¾è®¡é˜¶æ®µ
    ç³»ç»Ÿè®¾è®¡           :active,  des3, 2024-01-10, 5d
    ç•Œé¢è®¾è®¡           :         des4, after des3, 3d
    section å¼€å‘é˜¶æ®µ
    åç«¯å¼€å‘           :         des5, 2024-01-20, 10d
    å‰ç«¯å¼€å‘           :         des6, 2024-01-25, 8d
    æµ‹è¯•               :         des7, 2024-02-05, 5d`,

            class: `classDiagram
    class Animal {
        +String name
        +int age
        +makeSound()
    }
    class Dog {
        +String breed
        +bark()
    }
    class Cat {
        +String color
        +meow()
    }
    
    Animal <|-- Dog
    Animal <|-- Cat`,

            state: `stateDiagram-v2
    [*] --> Still
    Still --> [*]
    
    Still --> Moving
    Moving --> Still
    Moving --> Crash
    Crash --> [*]`,

            complex: `graph TD
    A[å¼€å§‹] --> B{æ¡ä»¶åˆ¤æ–­}
    B -->|æ˜¯| C[å¤„ç†A]
    B -->|å¦| D[å¤„ç†B]
    C --> E[åˆå¹¶ç»“æœ]
    D --> E
    E --> F{æ˜¯å¦æˆåŠŸ?}
    F -->|æ˜¯| G[ä¿å­˜æ•°æ®]
    F -->|å¦| H[é”™è¯¯å¤„ç†]
    G --> I[å‘é€é€šçŸ¥]
    H --> J[è®°å½•æ—¥å¿—]
    I --> K[ç»“æŸ]
    J --> K`
        };

        // åŠ è½½ç¤ºä¾‹
        function loadExample(type) {
            document.getElementById('mermaidCode').value = examples[type];
            renderGraph();
        }

        // æ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯
        function showStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
            statusEl.style.display = 'block';
            
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 3000);
        }

        // è§£æMermaidè¯­æ³•ä¸ºG6æ•°æ®æ ¼å¼
        function parseMermaidToG6(mermaidCode) {
            try {
                const parser = new MermaidParser();
                return parser.parse(mermaidCode);
            } catch (error) {
                console.error('è§£æMermaidä»£ç å¤±è´¥:', error);
                throw new Error('Mermaidè¯­æ³•è§£æå¤±è´¥: ' + error.message);
            }
        }

        // æ¸²æŸ“å›¾è¡¨
        function renderGraph() {
            const mermaidCode = document.getElementById('mermaidCode').value.trim();
            
            if (!mermaidCode) {
                showStatus('è¯·è¾“å…¥Mermaidä»£ç ', 'error');
                return;
            }

            try {
                // æ¸…ç©ºå®¹å™¨
                const container = document.getElementById('previewContainer');
                container.innerHTML = '';

                // è§£æMermaidä»£ç 
                const data = parseMermaidToG6(mermaidCode);
                currentData = data;

                if (data.nodes.length === 0) {
                    showStatus('æœªæ£€æµ‹åˆ°æœ‰æ•ˆçš„å›¾è¡¨ç»“æ„', 'error');
                    return;
                }

                // åˆ›å»ºG6å›¾å®ä¾‹
                graph = new G6.Graph({
                    container: 'previewContainer',
                    width: container.offsetWidth,
                    height: container.offsetHeight,
                    layout: {
                        type: 'dagre',
                        rankdir: 'TB',
                        nodesep: 60,
                        ranksep: 100,
                        controlPoints: true,
                    },
                    defaultNode: {
                        size: [80, 40],
                        style: {
                            fill: '#DEE9FF',
                            stroke: '#5B8FF9',
                            lineWidth: 2,
                            radius: 6,
                        },
                        labelCfg: {
                            style: {
                                fill: '#333',
                                fontSize: 12,
                                fontWeight: 'bold',
                            },
                        },
                    },
                    defaultEdge: {
                        style: {
                            stroke: '#b5b5b5',
                            lineWidth: 2,
                            endArrow: {
                                path: G6.Arrow.triangle(8, 6, 8),
                                fill: '#b5b5b5',
                            },
                        },
                        labelCfg: {
                            style: {
                                fill: '#666',
                                fontSize: 10,
                                background: {
                                    fill: 'white',
                                    stroke: '#ccc',
                                    padding: [2, 4, 2, 4],
                                    radius: 4,
                                },
                            },
                        },
                    },
                    nodeStateStyles: {
                        highlight: {
                            fill: '#ff4d4f',
                            stroke: '#ff4d4f',
                            lineWidth: 3,
                            shadowColor: '#ff4d4f',
                            shadowBlur: 10,
                        },
                        active: {
                            fill: '#52c41a',
                            stroke: '#52c41a',
                            lineWidth: 2,
                        },
                    },
                    edgeStateStyles: {
                        highlight: {
                            stroke: '#ff4d4f',
                            lineWidth: 4,
                            endArrow: {
                                path: G6.Arrow.triangle(10, 8, 10),
                                fill: '#ff4d4f',
                            },
                            shadowColor: '#ff4d4f',
                            shadowBlur: 8,
                        },
                        active: {
                            stroke: '#52c41a',
                            lineWidth: 3,
                        },
                    },
                    modes: {
                        default: [
                            'drag-canvas', 
                            'zoom-canvas', 
                            'drag-node',
                            'click-select'
                        ],
                    },
                    plugins: [
                        new G6.Grid(),
                    ],
                });

                // åŠ è½½æ•°æ®å¹¶æ¸²æŸ“
                graph.data(data);
                graph.render();

                // æ·»åŠ èŠ‚ç‚¹ç‚¹å‡»äº‹ä»¶
                graph.on('node:click', (evt) => {
                    const { item } = evt;
                    const nodeId = item.getID();
                    
                    // æ¸…é™¤æ‰€æœ‰é«˜äº®çŠ¶æ€
                    graph.getNodes().forEach((node) => {
                        graph.clearItemStates(node, 'highlight');
                    });
                    graph.getEdges().forEach((edge) => {
                        graph.clearItemStates(edge, 'highlight');
                    });

                    // é«˜äº®å½“å‰èŠ‚ç‚¹
                    graph.setItemState(item, 'highlight', true);

                    // é«˜äº®ç›¸å…³è¾¹å’Œè¿æ¥çš„èŠ‚ç‚¹
                    const relatedEdges = item.getEdges();
                    relatedEdges.forEach((edge) => {
                        graph.setItemState(edge, 'highlight', true);
                        
                        // é«˜äº®è¿æ¥çš„èŠ‚ç‚¹
                        const source = edge.getSource();
                        const target = edge.getTarget();
                        if (source.getID() !== nodeId) {
                            graph.setItemState(source, 'highlight', true);
                        }
                        if (target.getID() !== nodeId) {
                            graph.setItemState(target, 'highlight', true);
                        }
                    });

                    showStatus(`å·²é«˜äº®èŠ‚ç‚¹ "${item.getModel().label}" åŠå…¶ç›¸å…³è¿çº¿`, 'success');
                });

                // æ·»åŠ ç”»å¸ƒç‚¹å‡»äº‹ä»¶ï¼ˆæ¸…é™¤é«˜äº®ï¼‰
                graph.on('canvas:click', () => {
                    graph.getNodes().forEach((node) => {
                        graph.clearItemStates(node, 'highlight');
                    });
                    graph.getEdges().forEach((edge) => {
                        graph.clearItemStates(edge, 'highlight');
                    });
                });

                showStatus(`æˆåŠŸæ¸²æŸ“å›¾è¡¨ï¼ŒåŒ…å« ${data.nodes.length} ä¸ªèŠ‚ç‚¹å’Œ ${data.edges.length} æ¡è¿çº¿`, 'success');

            } catch (error) {
                console.error('æ¸²æŸ“å¤±è´¥:', error);
                showStatus('æ¸²æŸ“å¤±è´¥: ' + error.message, 'error');
            }
        }

        // å¤åˆ¶ä¸ºå›¾ç‰‡
        async function copyAsImage() {
            if (!graph) {
                showStatus('è¯·å…ˆæ¸²æŸ“å›¾è¡¨', 'error');
                return;
            }

            try {
                const canvas = document.querySelector('#previewContainer canvas');
                if (!canvas) {
                    showStatus('æœªæ‰¾åˆ°å›¾è¡¨ç”»å¸ƒ', 'error');
                    return;
                }

                // åˆ›å»ºç™½è‰²èƒŒæ™¯
                const tempCanvas = document.createElement('canvas');
                const tempCtx = tempCanvas.getContext('2d');
                tempCanvas.width = canvas.width;
                tempCanvas.height = canvas.height;
                
                // å¡«å……ç™½è‰²èƒŒæ™¯
                tempCtx.fillStyle = 'white';
                tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
                
                // ç»˜åˆ¶åŸå›¾
                tempCtx.drawImage(canvas, 0, 0);

                // è½¬æ¢ä¸ºblobå¹¶å¤åˆ¶
                tempCanvas.toBlob(async (blob) => {
                    try {
                        await navigator.clipboard.write([
                            new ClipboardItem({ 'image/png': blob })
                        ]);
                        showStatus('å›¾è¡¨å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
                    } catch (err) {
                        showStatus('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æƒé™', 'error');
                    }
                }, 'image/png');
            } catch (error) {
                console.error('å¤åˆ¶å¤±è´¥:', error);
                showStatus('å¤åˆ¶å¤±è´¥: ' + error.message, 'error');
            }
        }

        // ä¸‹è½½å›¾ç‰‡
        function downloadImage() {
            if (!graph) {
                showStatus('è¯·å…ˆæ¸²æŸ“å›¾è¡¨', 'error');
                return;
            }

            try {
                const canvas = document.querySelector('#previewContainer canvas');
                if (!canvas) {
                    showStatus('æœªæ‰¾åˆ°å›¾è¡¨ç”»å¸ƒ', 'error');
                    return;
                }

                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const link = document.createElement('a');
                link.download = 'mermaid-diagram.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
                
                showStatus('å›¾ç‰‡ä¸‹è½½å·²å¼€å§‹', 'success');
            } catch (error) {
                console.error('ä¸‹è½½å¤±è´¥:', error);
                showStatus('ä¸‹è½½å¤±è´¥: ' + error.message, 'error');
            }
        }

        // é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                renderGraph();
            }
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                copyAsImage();
            }
        });

        // çª—å£å¤§å°æ”¹å˜æ—¶é‡æ–°è°ƒæ•´å›¾è¡¨å¤§å°
        window.addEventListener('resize', () => {
            if (graph) {
                const container = document.getElementById('previewContainer');
                graph.changeSize(container.offsetWidth, container.offsetHeight);
            }
        });

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æ¸²æŸ“é»˜è®¤ç¤ºä¾‹
        window.addEventListener('load', () => {
            setTimeout(() => {
                renderGraph();
            }, 500);
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>增强版 Mermaid 交互式渲染器</title>
    <script src="https://cdn.jsdelivr.net/npm/@antv/g6@4.8.24/dist/g6.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="mermaid-parser.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
            min-height: 700px;
        }

        .editor-panel {
            padding: 30px;
            background: #f8f9fa;
            border-right: 1px solid #e9ecef;
        }

        .preview-panel {
            padding: 30px;
            background: white;
            position: relative;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
            font-size: 1.1em;
        }

        textarea {
            width: 100%;
            min-height: 400px;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            line-height: 1.5;
            resize: vertical;
            transition: border-color 0.3s ease;
        }

        textarea:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(79, 172, 254, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .examples {
            margin-top: 20px;
        }

        .example-btn {
            margin: 5px;
            padding: 8px 16px;
            background: #e9ecef;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .example-btn:hover {
            background: #dee2e6;
            transform: translateY(-1px);
        }

        .preview-container {
            width: 100%;
            height: 500px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            position: relative;
            overflow: hidden;
            background: #fafafa;
        }

        .preview-container canvas {
            border-radius: 8px;
        }

        .status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 6px;
            font-size: 14px;
            text-align: center;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .interaction-hint {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(79, 172, 254, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            z-index: 1000;
        }

        .legend {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 14px;
        }

        .legend h4 {
            margin-bottom: 10px;
            color: #495057;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            margin-right: 10px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .editor-panel {
                border-right: none;
                border-bottom: 1px solid #e9ecef;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚀 增强版 Mermaid 交互式渲染器</h1>
            <p>支持节点点击高亮连线，基于 AntV G6 引擎</p>
        </div>

        <div class="main-content">
            <div class="editor-panel">
                <div class="form-group">
                    <label for="mermaidCode">Mermaid 代码编辑器</label>
                    <textarea id="mermaidCode" placeholder="在此输入您的 Mermaid 代码...">graph TD
    A[开始] --> B{是否登录?}
    B -->|是| C[显示主页]
    B -->|否| D[显示登录页]
    D --> E[用户登录]
    E --> F{登录成功?}
    F -->|是| C
    F -->|否| G[显示错误信息]
    G --> D
    C --> H[结束]</textarea>
                </div>

                <div class="controls">
                    <button class="btn btn-primary" onclick="renderGraph()">
                        🔄 渲染图表
                    </button>
                    <button class="btn btn-success" onclick="copyAsImage()">
                        📋 复制为图片
                    </button>
                    <button class="btn btn-secondary" onclick="downloadImage()">
                        💾 下载图片
                    </button>
                </div>

                <div class="examples">
                    <h4>快速示例：</h4>
                    <button class="example-btn" onclick="loadExample('flowchart')">流程图</button>
                    <button class="example-btn" onclick="loadExample('sequence')">时序图</button>
                    <button class="example-btn" onclick="loadExample('gantt')">甘特图</button>
                    <button class="example-btn" onclick="loadExample('class')">类图</button>
                    <button class="example-btn" onclick="loadExample('state')">状态图</button>
                    <button class="example-btn" onclick="loadExample('complex')">复杂流程图</button>
                </div>

                <div id="status" class="status info" style="display: none;"></div>
            </div>

            <div class="preview-panel">
                <div class="interaction-hint">
                    💡 点击节点可高亮相关连线
                </div>
                <div class="preview-container" id="previewContainer">
                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #6c757d;">
                        点击"渲染图表"开始
                    </div>
                </div>

                <div class="legend">
                    <h4>交互说明：</h4>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #5B8FF9;"></div>
                        <span>普通节点</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ff4d4f;"></div>
                        <span>高亮节点</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #b5b5b5;"></div>
                        <span>普通连线</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ff4d4f;"></div>
                        <span>高亮连线</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let graph = null;
        let currentData = null;

        // 示例数据
        const examples = {
            flowchart: `graph TD
    A[开始] --> B{是否登录?}
    B -->|是| C[显示主页]
    B -->|否| D[显示登录页]
    D --> E[用户登录]
    E --> F{登录成功?}
    F -->|是| C
    F -->|否| G[显示错误信息]
    G --> D
    C --> H[结束]`,

            sequence: `sequenceDiagram
    participant U as 用户
    participant F as 前端
    participant B as 后端
    participant D as 数据库
    
    U->>F: 登录请求
    F->>B: 验证用户信息
    B->>D: 查询用户数据
    D-->>B: 返回用户信息
    B-->>F: 返回验证结果
    F-->>U: 显示登录状态`,

            gantt: `gantt
    title 项目开发计划
    dateFormat  YYYY-MM-DD
    section 需求分析
    需求收集           :done,    des1, 2024-01-01,2024-01-05
    需求分析           :done,    des2, 2024-01-06, 3d
    section 设计阶段
    系统设计           :active,  des3, 2024-01-10, 5d
    界面设计           :         des4, after des3, 3d
    section 开发阶段
    后端开发           :         des5, 2024-01-20, 10d
    前端开发           :         des6, 2024-01-25, 8d
    测试               :         des7, 2024-02-05, 5d`,

            class: `classDiagram
    class Animal {
        +String name
        +int age
        +makeSound()
    }
    class Dog {
        +String breed
        +bark()
    }
    class Cat {
        +String color
        +meow()
    }
    
    Animal <|-- Dog
    Animal <|-- Cat`,

            state: `stateDiagram-v2
    [*] --> Still
    Still --> [*]
    
    Still --> Moving
    Moving --> Still
    Moving --> Crash
    Crash --> [*]`,

            complex: `graph TD
    A[开始] --> B{条件判断}
    B -->|是| C[处理A]
    B -->|否| D[处理B]
    C --> E[合并结果]
    D --> E
    E --> F{是否成功?}
    F -->|是| G[保存数据]
    F -->|否| H[错误处理]
    G --> I[发送通知]
    H --> J[记录日志]
    I --> K[结束]
    J --> K`
        };

        // 加载示例
        function loadExample(type) {
            document.getElementById('mermaidCode').value = examples[type];
            renderGraph();
        }

        // 显示状态信息
        function showStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
            statusEl.style.display = 'block';
            
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 3000);
        }

        // 解析Mermaid语法为G6数据格式
        function parseMermaidToG6(mermaidCode) {
            try {
                const parser = new MermaidParser();
                return parser.parse(mermaidCode);
            } catch (error) {
                console.error('解析Mermaid代码失败:', error);
                throw new Error('Mermaid语法解析失败: ' + error.message);
            }
        }

        // 渲染图表
        function renderGraph() {
            const mermaidCode = document.getElementById('mermaidCode').value.trim();
            
            if (!mermaidCode) {
                showStatus('请输入Mermaid代码', 'error');
                return;
            }

            try {
                // 清空容器
                const container = document.getElementById('previewContainer');
                container.innerHTML = '';

                // 解析Mermaid代码
                const data = parseMermaidToG6(mermaidCode);
                currentData = data;

                if (data.nodes.length === 0) {
                    showStatus('未检测到有效的图表结构', 'error');
                    return;
                }

                // 创建G6图实例
                graph = new G6.Graph({
                    container: 'previewContainer',
                    width: container.offsetWidth,
                    height: container.offsetHeight,
                    layout: {
                        type: 'dagre',
                        rankdir: 'TB',
                        nodesep: 60,
                        ranksep: 100,
                        controlPoints: true,
                    },
                    defaultNode: {
                        size: [80, 40],
                        style: {
                            fill: '#DEE9FF',
                            stroke: '#5B8FF9',
                            lineWidth: 2,
                            radius: 6,
                        },
                        labelCfg: {
                            style: {
                                fill: '#333',
                                fontSize: 12,
                                fontWeight: 'bold',
                            },
                        },
                    },
                    defaultEdge: {
                        style: {
                            stroke: '#b5b5b5',
                            lineWidth: 2,
                            endArrow: {
                                path: G6.Arrow.triangle(8, 6, 8),
                                fill: '#b5b5b5',
                            },
                        },
                        labelCfg: {
                            style: {
                                fill: '#666',
                                fontSize: 10,
                                background: {
                                    fill: 'white',
                                    stroke: '#ccc',
                                    padding: [2, 4, 2, 4],
                                    radius: 4,
                                },
                            },
                        },
                    },
                    nodeStateStyles: {
                        highlight: {
                            fill: '#ff4d4f',
                            stroke: '#ff4d4f',
                            lineWidth: 3,
                            shadowColor: '#ff4d4f',
                            shadowBlur: 10,
                        },
                        active: {
                            fill: '#52c41a',
                            stroke: '#52c41a',
                            lineWidth: 2,
                        },
                    },
                    edgeStateStyles: {
                        highlight: {
                            stroke: '#ff4d4f',
                            lineWidth: 4,
                            endArrow: {
                                path: G6.Arrow.triangle(10, 8, 10),
                                fill: '#ff4d4f',
                            },
                            shadowColor: '#ff4d4f',
                            shadowBlur: 8,
                        },
                        active: {
                            stroke: '#52c41a',
                            lineWidth: 3,
                        },
                    },
                    modes: {
                        default: [
                            'drag-canvas', 
                            'zoom-canvas', 
                            'drag-node',
                            'click-select'
                        ],
                    },
                    plugins: [
                        new G6.Grid(),
                    ],
                });

                // 加载数据并渲染
                graph.data(data);
                graph.render();

                // 添加节点点击事件
                graph.on('node:click', (evt) => {
                    const { item } = evt;
                    const nodeId = item.getID();
                    
                    // 清除所有高亮状态
                    graph.getNodes().forEach((node) => {
                        graph.clearItemStates(node, 'highlight');
                    });
                    graph.getEdges().forEach((edge) => {
                        graph.clearItemStates(edge, 'highlight');
                    });

                    // 高亮当前节点
                    graph.setItemState(item, 'highlight', true);

                    // 高亮相关边和连接的节点
                    const relatedEdges = item.getEdges();
                    relatedEdges.forEach((edge) => {
                        graph.setItemState(edge, 'highlight', true);
                        
                        // 高亮连接的节点
                        const source = edge.getSource();
                        const target = edge.getTarget();
                        if (source.getID() !== nodeId) {
                            graph.setItemState(source, 'highlight', true);
                        }
                        if (target.getID() !== nodeId) {
                            graph.setItemState(target, 'highlight', true);
                        }
                    });

                    showStatus(`已高亮节点 "${item.getModel().label}" 及其相关连线`, 'success');
                });

                // 添加画布点击事件（清除高亮）
                graph.on('canvas:click', () => {
                    graph.getNodes().forEach((node) => {
                        graph.clearItemStates(node, 'highlight');
                    });
                    graph.getEdges().forEach((edge) => {
                        graph.clearItemStates(edge, 'highlight');
                    });
                });

                showStatus(`成功渲染图表，包含 ${data.nodes.length} 个节点和 ${data.edges.length} 条连线`, 'success');

            } catch (error) {
                console.error('渲染失败:', error);
                showStatus('渲染失败: ' + error.message, 'error');
            }
        }

        // 复制为图片
        async function copyAsImage() {
            if (!graph) {
                showStatus('请先渲染图表', 'error');
                return;
            }

            try {
                const canvas = document.querySelector('#previewContainer canvas');
                if (!canvas) {
                    showStatus('未找到图表画布', 'error');
                    return;
                }

                // 创建白色背景
                const tempCanvas = document.createElement('canvas');
                const tempCtx = tempCanvas.getContext('2d');
                tempCanvas.width = canvas.width;
                tempCanvas.height = canvas.height;
                
                // 填充白色背景
                tempCtx.fillStyle = 'white';
                tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
                
                // 绘制原图
                tempCtx.drawImage(canvas, 0, 0);

                // 转换为blob并复制
                tempCanvas.toBlob(async (blob) => {
                    try {
                        await navigator.clipboard.write([
                            new ClipboardItem({ 'image/png': blob })
                        ]);
                        showStatus('图表已复制到剪贴板', 'success');
                    } catch (err) {
                        showStatus('复制失败，请检查浏览器权限', 'error');
                    }
                }, 'image/png');
            } catch (error) {
                console.error('复制失败:', error);
                showStatus('复制失败: ' + error.message, 'error');
            }
        }

        // 下载图片
        function downloadImage() {
            if (!graph) {
                showStatus('请先渲染图表', 'error');
                return;
            }

            try {
                const canvas = document.querySelector('#previewContainer canvas');
                if (!canvas) {
                    showStatus('未找到图表画布', 'error');
                    return;
                }

                // 创建下载链接
                const link = document.createElement('a');
                link.download = 'mermaid-diagram.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
                
                showStatus('图片下载已开始', 'success');
            } catch (error) {
                console.error('下载失败:', error);
                showStatus('下载失败: ' + error.message, 'error');
            }
        }

        // 键盘快捷键
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                renderGraph();
            }
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                copyAsImage();
            }
        });

        // 窗口大小改变时重新调整图表大小
        window.addEventListener('resize', () => {
            if (graph) {
                const container = document.getElementById('previewContainer');
                graph.changeSize(container.offsetWidth, container.offsetHeight);
            }
        });

        // 页面加载完成后自动渲染默认示例
        window.addEventListener('load', () => {
            setTimeout(() => {
                renderGraph();
            }, 500);
        });
    </script>
</body>
</html>
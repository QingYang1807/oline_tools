<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>æ¥å£è¯·æ±‚å·¥å…· Â· ç½‘é¡µå·¥å…·ç®±</title>
  <link rel="stylesheet" href="../../assets/css/style.css">
  <meta name="color-scheme" content="light dark">
  <style>
    .api-tester {
      max-width: 1000px;
      margin: 0 auto;
    }
    
    .request-section {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 2px 8px var(--shadow);
    }
    
    .request-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .method-select {
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--card);
      color: var(--fg);
      font-size: 14px;
      min-width: 80px;
    }
    
    .url-input {
      flex: 1;
      min-width: 300px;
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--card);
      color: var(--fg);
      font-size: 14px;
    }
    
    .send-btn {
      padding: 8px 20px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: background 0.2s;
    }
    
    .send-btn:hover {
      background: var(--accent-hover);
    }
    
    .send-btn:disabled {
      background: var(--muted);
      cursor: not-allowed;
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--fg);
    }
    
    .form-input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--card);
      color: var(--fg);
      font-size: 14px;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    }
    
    .form-textarea {
      min-height: 120px;
      resize: vertical;
    }
    
    .tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
      margin-bottom: 16px;
    }
    
    .tab {
      padding: 8px 16px;
      border: none;
      background: none;
      color: var(--muted);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }
    
    .tab.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .response-section {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 2px 8px var(--shadow);
    }
    
    .response-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
    }
    
    .status-badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .status-success {
      background: #10b981;
      color: white;
    }
    
    .status-error {
      background: #ef4444;
      color: white;
    }
    
    .status-info {
      background: #3b82f6;
      color: white;
    }
    
    .response-time {
      color: var(--muted);
      font-size: 14px;
    }
    
    .response-content {
      background: var(--panel-bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 16px;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 13px;
      line-height: 1.5;
      white-space: pre-wrap;
      word-break: break-all;
      max-height: 400px;
      overflow-y: auto;
    }
    
    .headers-grid {
      display: grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 8px;
      align-items: center;
    }
    
    .add-header-btn {
      padding: 6px 12px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    
    .remove-header-btn {
      padding: 4px 8px;
      background: #ef4444;
      color: white;
      border: none;
          border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid var(--border);
      border-radius: 50%;
      border-top-color: var(--accent);
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .history-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .history-item:hover {
      background: var(--panel-bg);
    }
    
    .history-method {
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
      min-width: 40px;
      text-align: center;
    }
    
    .method-get { background: #10b981; color: white; }
    .method-post { background: #3b82f6; color: white; }
    .method-put { background: #f59e0b; color: white; }
    .method-delete { background: #ef4444; color: white; }
    .method-patch { background: #8b5cf6; color: white; }
    
    .history-url {
      flex: 1;
      font-size: 13px;
      color: var(--fg);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .history-time {
      font-size: 12px;
      color: var(--muted);
    }
    
    .clear-history-btn {
      padding: 6px 12px;
      background: var(--muted);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      margin-left: auto;
    }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="container">
      <h1 class="site-title">ğŸ”Œ æ¥å£è¯·æ±‚å·¥å…·</h1>
      <p class="site-subtitle">ç®€æ˜“çš„ API æµ‹è¯•å·¥å…·ï¼Œæ”¯æŒ GET/POST ç­‰å¤šç§è¯·æ±‚æ–¹æ³•</p>
    </div>
  </header>

  <main class="container">
    <div class="api-tester">
      <!-- è¯·æ±‚å†å² -->
      <div class="request-section">
        <h3>è¯·æ±‚å†å²</h3>
        <div id="requestHistory"></div>
        <button class="clear-history-btn" onclick="clearHistory()">æ¸…ç©ºå†å²</button>
      </div>

      <!-- åŠŸèƒ½è¯´æ˜ -->
      <div class="request-section">
        <h3>ğŸš€ æ–°åŠŸèƒ½è¯´æ˜</h3>
        <div style="background: var(--panel-bg); padding: 16px; border-radius: 8px; border-left: 4px solid var(--accent);">
          <p style="margin: 0 0 12px 0; color: var(--fg);"><strong>âœ… å·²è§£å†³307é‡å®šå‘è·¨åŸŸé—®é¢˜ï¼</strong></p>
          <ul style="margin: 0; padding-left: 20px; color: var(--muted);">
            <li><strong>ä»£ç†æœåŠ¡å™¨æ¨¡å¼ï¼š</strong>è‡ªåŠ¨ä½¿ç”¨å¤šä¸ªä»£ç†æœåŠ¡å™¨ï¼Œè§£å†³è·¨åŸŸé™åˆ¶</li>
            <li><strong>é‡å®šå‘å¤„ç†ï¼š</strong>æ”¯æŒè‡ªåŠ¨è·Ÿéšé‡å®šå‘ï¼Œæˆ–æ‰‹åŠ¨å¤„ç†é‡å®šå‘é“¾</li>
            <li><strong>æ™ºèƒ½åˆ‡æ¢ï¼š</strong>ä»£ç†æœåŠ¡å™¨å¤±è´¥æ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°å¤‡ç”¨æœåŠ¡å™¨</li>
            <li><strong>å®Œæ•´æ”¯æŒï¼š</strong>æ”¯æŒæ‰€æœ‰HTTPæ–¹æ³•å’Œè¯·æ±‚ç±»å‹</li>
          </ul>
        </div>
      </div>

      <!-- è¯·æ±‚é…ç½® -->
      <div class="request-section">
        <h3>è¯·æ±‚é…ç½®</h3>
        
        <div class="request-header">
          <select id="methodSelect" class="method-select">
            <option value="GET">GET</option>
            <option value="POST">POST</option>
            <option value="PUT">PUT</option>
            <option value="DELETE">DELETE</option>
            <option value="PATCH">PATCH</option>
          </select>
          
          <input type="url" id="urlInput" class="url-input" placeholder="è¯·è¾“å…¥è¯·æ±‚ URL" value="https://httpbin.org/get">
          
          <!-- æµ‹è¯•URLå¿«æ·æŒ‰é’® -->
          <div style="display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap;">
            <button onclick="setTestUrl('https://httpbin.org/get')" style="padding: 4px 8px; background: var(--muted); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">æµ‹è¯•GET</button>
            <button onclick="setTestUrl('https://httpbin.org/redirect/3')" style="padding: 4px 8px; background: var(--muted); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">æµ‹è¯•é‡å®šå‘</button>
            <button onclick="setTestUrl('https://api.github.com/users/octocat')" style="padding: 4px 8px; background: var(--muted); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">æµ‹è¯•è·¨åŸŸ</button>
            <button onclick="setTestUrl('https://httpbin.org/status/307')" style="padding: 4px 8px; background: var(--muted); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">æµ‹è¯•307</button>
          </div>
          
          <button id="sendBtn" class="send-btn" onclick="sendRequest()">
            <span id="sendBtnText">å‘é€è¯·æ±‚</span>
            <span id="sendBtnLoading" class="loading" style="display: none;"></span>
          </button>
        </div>

        <!-- è¯·æ±‚é€‰é¡¹ -->
        <div class="form-group">
          <label class="form-label">è¯·æ±‚é€‰é¡¹</label>
          <div style="display: flex; gap: 16px; flex-wrap: wrap; align-items: center;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="useProxy" checked>
              <span>ä½¿ç”¨ä»£ç†æœåŠ¡å™¨ï¼ˆè§£å†³è·¨åŸŸé—®é¢˜ï¼‰</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="followRedirects" checked>
              <span>è‡ªåŠ¨è·Ÿéšé‡å®šå‘</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="includeCredentials">
              <span>åŒ…å«å‡­æ®ï¼ˆCookiesç­‰ï¼‰</span>
            </label>
          </div>
        </div>

        <!-- è¯·æ±‚å¤´ -->
        <div class="form-group">
          <label class="form-label">è¯·æ±‚å¤´</label>
          <div id="headersContainer">
            <div class="headers-grid">
              <input type="text" class="form-input header-key" placeholder="Header åç§°" value="Content-Type">
              <input type="text" class="form-input header-value" placeholder="Header å€¼" value="application/json">
              <button class="remove-header-btn" onclick="removeHeader(this)">åˆ é™¤</button>
            </div>
          </div>
          <button class="add-header-btn" onclick="addHeader()">æ·»åŠ è¯·æ±‚å¤´</button>
        </div>

        <!-- è¯·æ±‚ä½“ -->
        <div class="form-group">
          <label class="form-label">è¯·æ±‚ä½“</label>
          <div class="tabs">
            <button class="tab active" onclick="switchTab('json')">JSON</button>
            <button class="tab" onclick="switchTab('form')">Form Data</button>
            <button class="tab" onclick="switchTab('raw')">Raw</button>
          </div>
          
          <div id="jsonTab" class="tab-content active">
            <textarea id="jsonBody" class="form-input form-textarea" placeholder='{"key": "value"}'>{
  "name": "test",
  "message": "Hello World"
}</textarea>
          </div>
          
          <div id="formTab" class="tab-content">
            <div id="formDataContainer">
              <div class="headers-grid">
                <input type="text" class="form-input form-key" placeholder="å‚æ•°å" value="name">
                <input type="text" class="form-input form-value" placeholder="å‚æ•°å€¼" value="test">
                <button class="remove-header-btn" onclick="removeFormField(this)">åˆ é™¤</button>
              </div>
            </div>
            <button class="add-header-btn" onclick="addFormField()">æ·»åŠ å‚æ•°</button>
          </div>
          
          <div id="rawTab" class="tab-content">
            <textarea id="rawBody" class="form-input form-textarea" placeholder="è¾“å…¥åŸå§‹è¯·æ±‚ä½“å†…å®¹"></textarea>
          </div>
        </div>
      </div>

      <!-- å“åº”ç»“æœ -->
      <div class="response-section">
        <h3>å“åº”ç»“æœ</h3>
        <div id="responseContent" style="display: none;">
          <div class="response-header">
            <div>
              <span id="statusBadge" class="status-badge status-info">200 OK</span>
              <span id="responseTime" class="response-time">å“åº”æ—¶é—´: 0ms</span>
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">å“åº”å¤´</label>
            <pre id="responseHeaders" class="response-content"></pre>
          </div>
          
          <div class="form-group">
            <label class="form-label">å“åº”ä½“</label>
            <pre id="responseBody" class="response-content"></pre>
          </div>
        </div>
        
        <div id="noResponse" style="text-align: center; color: var(--muted); padding: 40px;">
          ç‚¹å‡»"å‘é€è¯·æ±‚"å¼€å§‹æµ‹è¯•æ¥å£
        </div>
      </div>
    </div>
  </main>

  <footer class="site-footer">
    <div class="container">
      <span>Â© <span id="year"></span> ç½‘é¡µå·¥å…·ç®±</span>
    </div>
  </footer>

  <script>
    // è¯·æ±‚å†å²
    let requestHistory = JSON.parse(localStorage.getItem('apiTesterHistory') || '[]');
    
    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('year').textContent = new Date().getFullYear();
      renderHistory();
      
      // ç›‘å¬æ–¹æ³•å˜åŒ–ï¼Œè‡ªåŠ¨æ˜¾ç¤º/éšè—è¯·æ±‚ä½“
      document.getElementById('methodSelect').addEventListener('change', function() {
        const method = this.value;
        const bodySection = document.querySelector('.form-group:last-child');
        if (method === 'GET') {
          bodySection.style.display = 'none';
        } else {
          bodySection.style.display = 'block';
        }
      });
      
      // åˆå§‹éšè— GET æ–¹æ³•çš„è¯·æ±‚ä½“
      if (document.getElementById('methodSelect').value === 'GET') {
        document.querySelector('.form-group:last-child').style.display = 'none';
      }
    });
    
    // åˆ‡æ¢æ ‡ç­¾é¡µ
    function switchTab(tabName) {
      // éšè—æ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // ç§»é™¤æ‰€æœ‰æ ‡ç­¾é¡µçš„æ¿€æ´»çŠ¶æ€
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾é¡µå†…å®¹
      document.getElementById(tabName + 'Tab').classList.add('active');
      
      // æ¿€æ´»å¯¹åº”çš„æ ‡ç­¾
      event.target.classList.add('active');
    }
    
    // æ·»åŠ è¯·æ±‚å¤´
    function addHeader() {
      const container = document.getElementById('headersContainer');
      const headerDiv = document.createElement('div');
      headerDiv.className = 'headers-grid';
      headerDiv.innerHTML = `
        <input type="text" class="form-input header-key" placeholder="Header åç§°">
        <input type="text" class="form-input header-value" placeholder="Header å€¼">
        <button class="remove-header-btn" onclick="removeHeader(this)">åˆ é™¤</button>
      `;
      container.appendChild(headerDiv);
    }
    
    // åˆ é™¤è¯·æ±‚å¤´
    function removeHeader(btn) {
      btn.parentElement.remove();
    }
    
    // æ·»åŠ è¡¨å•å­—æ®µ
    function addFormField() {
      const container = document.getElementById('formDataContainer');
      const fieldDiv = document.createElement('div');
      fieldDiv.className = 'headers-grid';
      fieldDiv.innerHTML = `
        <input type="text" class="form-input form-key" placeholder="å‚æ•°å">
        <input type="text" class="form-input form-value" placeholder="å‚æ•°å€¼">
        <button class="remove-header-btn" onclick="removeFormField(this)">åˆ é™¤</button>
      `;
      container.appendChild(fieldDiv);
    }
    
    // åˆ é™¤è¡¨å•å­—æ®µ
    function removeFormField(btn) {
      btn.parentElement.remove();
    }
    
    // ä»£ç†æœåŠ¡å™¨åˆ—è¡¨
    const proxyServers = [
      'https://api.allorigins.win/raw?url=',
      'https://cors-anywhere.herokuapp.com/',
      'https://thingproxy.freeboard.io/fetch/',
      'https://api.codetabs.com/v1/proxy?quest='
    ];
    
    let currentProxyIndex = 0;
    
    // å‘é€è¯·æ±‚
    async function sendRequest() {
      const method = document.getElementById('methodSelect').value;
      let url = document.getElementById('urlInput').value.trim();
      
      if (!url) {
        alert('è¯·è¾“å…¥è¯·æ±‚ URL');
        return;
      }
      
      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      const sendBtn = document.getElementById('sendBtn');
      const sendBtnText = document.getElementById('sendBtnText');
      const sendBtnLoading = document.getElementById('sendBtnLoading');
      
      sendBtn.disabled = true;
      sendBtnText.style.display = 'none';
      sendBtnLoading.style.display = 'inline-block';
      
      try {
        const startTime = Date.now();
        
        // æ„å»ºè¯·æ±‚å¤´
        const headers = {};
        document.querySelectorAll('.header-key').forEach((keyInput, index) => {
          const key = keyInput.value.trim();
          const value = document.querySelectorAll('.header-value')[index].value.trim();
          if (key && value) {
            headers[key] = value;
          }
        });
        
        // æ„å»ºè¯·æ±‚ä½“
        let body = null;
        if (method !== 'GET') {
          const activeTab = document.querySelector('.tab.active').textContent.toLowerCase();
          
          if (activeTab === 'json') {
            const jsonBody = document.getElementById('jsonBody').value.trim();
            if (jsonBody) {
              try {
                body = JSON.stringify(JSON.parse(jsonBody));
                headers['Content-Type'] = 'application/json';
              } catch (e) {
                alert('JSON æ ¼å¼é”™è¯¯');
                return;
              }
            }
          } else if (activeTab === 'form') {
            const formData = new FormData();
            document.querySelectorAll('.form-key').forEach((keyInput, index) => {
              const key = keyInput.value.trim();
              const value = document.querySelectorAll('.form-value')[index].value.trim();
              if (key && value) {
                formData.append(key, value);
              }
            });
            body = formData;
            // FormData ä¼šè‡ªåŠ¨è®¾ç½® Content-Type
          } else if (activeTab === 'raw') {
            const rawBody = document.getElementById('rawBody').value.trim();
            if (rawBody) {
              body = rawBody;
            }
          }
        }
        
        // æ£€æŸ¥æ˜¯å¦ä½¿ç”¨ä»£ç†
        const useProxy = document.getElementById('useProxy').checked;
        const followRedirects = document.getElementById('followRedirects').checked;
        const includeCredentials = document.getElementById('includeCredentials').checked;
        
        let response;
        let redirectChain = [];
        let finalUrl = url;
        
        if (useProxy) {
          // ä½¿ç”¨ä»£ç†æœåŠ¡å™¨
          response = await sendRequestWithProxy(url, method, headers, body, followRedirects, includeCredentials);
          finalUrl = response.finalUrl || url;
          redirectChain = response.redirectChain || [];
        } else {
          // ç›´æ¥è¯·æ±‚
          const fetchOptions = {
            method: method,
            headers: headers,
            body: body,
            redirect: followRedirects ? 'follow' : 'manual',
            credentials: includeCredentials ? 'include' : 'same-origin'
          };
          
          response = await fetch(url, fetchOptions);
          
          // å¤„ç†æ‰‹åŠ¨é‡å®šå‘
          if (!followRedirects && (response.status === 301 || response.status === 302 || response.status === 307 || response.status === 308)) {
            const location = response.headers.get('Location');
            if (location) {
              redirectChain.push({
                from: url,
                to: location,
                status: response.status,
                statusText: response.statusText
              });
              finalUrl = location;
            }
          }
        }
        
        const endTime = Date.now();
        const responseTime = endTime - startTime;
        
        // è·å–å“åº”å¤´
        const responseHeaders = {};
        response.headers.forEach((value, key) => {
          responseHeaders[key] = value;
        });
        
        // è·å–å“åº”ä½“
        let responseBody;
        const contentType = response.headers.get('content-type') || '';
        if (contentType.includes('application/json')) {
          try {
            responseBody = await response.json();
            responseBody = JSON.stringify(responseBody, null, 2);
          } catch (e) {
            responseBody = await response.text();
          }
        } else {
          responseBody = await response.text();
        }
        
        // æ¸…ç†ä¹‹å‰çš„é‡å®šå‘ä¿¡æ¯
        clearRedirectInfo();
        
        // æ˜¾ç¤ºå“åº”ç»“æœ
        displayResponse(response.status, response.statusText, responseTime, responseHeaders, responseBody, redirectChain, finalUrl);
        
        // ä¿å­˜åˆ°å†å²è®°å½•
        saveToHistory(method, url, response.status);
        
      } catch (error) {
        console.error('è¯·æ±‚å¤±è´¥:', error);
        displayError(error.message);
      } finally {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        sendBtn.disabled = false;
        sendBtnText.style.display = 'inline';
        sendBtnLoading.style.display = 'none';
      }
    }
    
    // ä½¿ç”¨ä»£ç†æœåŠ¡å™¨å‘é€è¯·æ±‚
    async function sendRequestWithProxy(originalUrl, method, headers, body, followRedirects, includeCredentials) {
      const proxyUrl = proxyServers[currentProxyIndex] + encodeURIComponent(originalUrl);
      
      try {
        const proxyHeaders = {
          ...headers,
          'X-Requested-With': 'XMLHttpRequest'
        };
        
        const fetchOptions = {
          method: method,
          headers: proxyHeaders,
          body: body,
          redirect: followRedirects ? 'follow' : 'manual',
          credentials: includeCredentials ? 'include' : 'same-origin'
        };
        
        const response = await fetch(proxyUrl, fetchOptions);
        
        // å¦‚æœä»£ç†å¤±è´¥ï¼Œå°è¯•ä¸‹ä¸€ä¸ªä»£ç†
        if (!response.ok && response.status >= 500) {
          currentProxyIndex = (currentProxyIndex + 1) % proxyServers.length;
          console.log(`ä»£ç†æœåŠ¡å™¨å¤±è´¥ï¼Œåˆ‡æ¢åˆ°: ${proxyServers[currentProxyIndex]}`);
          return await sendRequestWithProxy(originalUrl, method, headers, body, followRedirects, includeCredentials);
        }
        
        return {
          ...response,
          finalUrl: originalUrl,
          redirectChain: []
        };
        
      } catch (error) {
        // å°è¯•ä¸‹ä¸€ä¸ªä»£ç†æœåŠ¡å™¨
        currentProxyIndex = (currentProxyIndex + 1) % proxyServers.length;
        if (currentProxyIndex === 0) {
          throw new Error(`æ‰€æœ‰ä»£ç†æœåŠ¡å™¨éƒ½å¤±è´¥äº†: ${error.message}`);
        }
        console.log(`ä»£ç†æœåŠ¡å™¨é”™è¯¯ï¼Œåˆ‡æ¢åˆ°: ${proxyServers[currentProxyIndex]}`);
        return await sendRequestWithProxy(originalUrl, method, headers, body, followRedirects, includeCredentials);
      }
    }
    
    // æ¸…ç†é‡å®šå‘ä¿¡æ¯æ˜¾ç¤º
    function clearRedirectInfo() {
      const responseHeader = document.querySelector('.response-header');
      const existingRedirectInfo = responseHeader.querySelector('.redirect-info');
      if (existingRedirectInfo) {
        existingRedirectInfo.remove();
      }
    }
    
    // æ‰‹åŠ¨è·Ÿéšé‡å®šå‘
    async function followRedirect(redirectUrl) {
      document.getElementById('urlInput').value = redirectUrl;
      await sendRequest();
    }
    
    // è®¾ç½®æµ‹è¯•URL
    function setTestUrl(url) {
      document.getElementById('urlInput').value = url;
    }
    
    // æ˜¾ç¤ºå“åº”ç»“æœ
    function displayResponse(status, statusText, responseTime, headers, body, redirectChain = [], finalUrl = '') {
      document.getElementById('noResponse').style.display = 'none';
      document.getElementById('responseContent').style.display = 'block';
      
      // çŠ¶æ€ç 
      const statusBadge = document.getElementById('statusBadge');
      statusBadge.textContent = `${status} ${statusText}`;
      statusBadge.className = 'status-badge ' + (status >= 200 && status < 300 ? 'status-success' : 'status-error');
      
      // å“åº”æ—¶é—´
      document.getElementById('responseTime').textContent = `å“åº”æ—¶é—´: ${responseTime}ms`;
      
      // å¦‚æœæœ‰é‡å®šå‘é“¾ï¼Œæ˜¾ç¤ºé‡å®šå‘ä¿¡æ¯
      if (redirectChain.length > 0) {
        const redirectInfo = document.createElement('div');
        redirectInfo.className = 'redirect-info';
        redirectInfo.style.marginBottom = '16px';
        redirectInfo.style.padding = '12px';
        redirectInfo.style.backgroundColor = 'var(--panel-bg)';
        redirectInfo.style.border = '1px solid var(--border)';
        redirectInfo.style.borderRadius = '6px';
        redirectInfo.innerHTML = `
          <div style="font-weight: 500; margin-bottom: 8px; color: var(--accent);">é‡å®šå‘é“¾:</div>
          ${redirectChain.map(redirect => `
            <div style="margin-bottom: 8px; font-size: 13px; padding: 8px; background: var(--card); border-radius: 4px;">
              <div style="color: var(--muted); margin-bottom: 4px;">${redirect.status} ${redirect.statusText}</div>
              <div style="color: var(--fg); margin-bottom: 4px;">ä»: ${redirect.from}</div>
              <div style="color: var(--accent); margin-bottom: 8px;">åˆ°: ${redirect.to}</div>
              <button onclick="followRedirect('${redirect.to}')" style="padding: 4px 8px; background: var(--accent); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">è·Ÿéšé‡å®šå‘</button>
            </div>
          `).join('')}
          ${finalUrl ? `<div style="margin-top: 8px; font-weight: 500; color: var(--accent);">æœ€ç»ˆURL: ${finalUrl}</div>` : ''}
        `;
        
        const responseHeader = document.querySelector('.response-header');
        responseHeader.appendChild(redirectInfo);
      }
      
      // å“åº”å¤´
      document.getElementById('responseHeaders').textContent = JSON.stringify(headers, null, 2);
      
      // å“åº”ä½“
      document.getElementById('responseBody').textContent = body;
    }
    
    // æ˜¾ç¤ºé”™è¯¯
    function displayError(message) {
      document.getElementById('noResponse').style.display = 'none';
      document.getElementById('responseContent').style.display = 'block';
      
      document.getElementById('statusBadge').textContent = 'Error';
      document.getElementById('statusBadge').className = 'status-badge status-error';
      document.getElementById('responseTime').textContent = 'è¯·æ±‚å¤±è´¥';
      document.getElementById('responseHeaders').textContent = '';
      document.getElementById('responseBody').textContent = `è¯·æ±‚å¤±è´¥: ${message}`;
    }
    
    // ä¿å­˜åˆ°å†å²è®°å½•
    function saveToHistory(method, url, status) {
      const historyItem = {
        method: method,
        url: url,
        status: status,
        timestamp: new Date().toLocaleString()
      };
      
      // é¿å…é‡å¤è®°å½•
      const existingIndex = requestHistory.findIndex(item => 
        item.method === method && item.url === url
      );
      
      if (existingIndex !== -1) {
        requestHistory.splice(existingIndex, 1);
      }
      
      requestHistory.unshift(historyItem);
      
      // é™åˆ¶å†å²è®°å½•æ•°é‡
      if (requestHistory.length > 20) {
        requestHistory = requestHistory.slice(0, 20);
      }
      
      localStorage.setItem('apiTesterHistory', JSON.stringify(requestHistory));
      renderHistory();
    }
    
    // æ¸²æŸ“å†å²è®°å½•
    function renderHistory() {
      const container = document.getElementById('requestHistory');
      if (requestHistory.length === 0) {
        container.innerHTML = '<p style="color: var(--muted); text-align: center;">æš‚æ— è¯·æ±‚å†å²</p>';
        return;
      }
      
      container.innerHTML = requestHistory.map(item => `
        <div class="history-item" onclick="loadFromHistory('${item.method}', '${item.url}')">
          <span class="history-method method-${item.method.toLowerCase()}">${item.method}</span>
          <span class="history-url">${item.url}</span>
          <span class="history-time">${item.timestamp}</span>
        </div>
      `).join('');
    }
    
    // ä»å†å²è®°å½•åŠ è½½
    function loadFromHistory(method, url) {
      document.getElementById('methodSelect').value = method;
      document.getElementById('urlInput').value = url;
      
      // æ»šåŠ¨åˆ°è¯·æ±‚é…ç½®åŒºåŸŸ
      document.querySelector('.request-section:nth-child(2)').scrollIntoView({ behavior: 'smooth' });
    }
    
    // æ¸…ç©ºå†å²è®°å½•
    function clearHistory() {
      if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰è¯·æ±‚å†å²å—ï¼Ÿ')) {
        requestHistory = [];
        localStorage.removeItem('apiTesterHistory');
        renderHistory();
      }
    }
  </script>
</body>
</html>
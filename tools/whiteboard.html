<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <title>ç½‘é¡µç”»æ¿å·¥å…·</title>
  <link rel="stylesheet" href="../assets/css/style.css">
  <style>
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      touch-action: none; /* é˜²æ­¢ç§»åŠ¨ç«¯æ»šåŠ¨ */
    }

    .whiteboard-container {
      display: flex;
      height: 100vh;
      background: #f5f5f5;
      position: relative;
    }

    /* å“åº”å¼å·¥å…·æ  */
    .toolbar {
      width: 80px;
      background: #fff;
      box-shadow: 2px 0 10px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 15px 0;
      z-index: 100;
      transition: all 0.3s ease;
    }

    /* ç§»åŠ¨ç«¯å·¥å…·æ  */
    @media (max-width: 768px) {
      .toolbar {
        width: 100%;
        height: 80px;
        flex-direction: row;
        justify-content: space-around;
        padding: 10px 20px;
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        top: auto;
        border-top: 1px solid #e0e0e0;
      }
      
      .whiteboard-container {
        flex-direction: column;
      }
      
      .canvas-container {
        margin-bottom: 80px;
      }
    }

    .tool-btn {
      width: 60px;
      height: 60px;
      margin: 8px;
      border: none;
      background: #f0f0f0;
      border-radius: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
      position: relative;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    /* ç§»åŠ¨ç«¯æŒ‰é’®æ ·å¼ */
    @media (max-width: 768px) {
      .tool-btn {
        width: 50px;
        height: 50px;
        margin: 5px;
        border-radius: 10px;
      }
    }

    .tool-btn:hover, .tool-btn:active {
      background: #e0e0e0;
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .tool-btn.active {
      background: #4CAF50;
      color: white;
      box-shadow: 0 4px 16px rgba(76, 175, 80, 0.4);
    }

    .tool-btn svg {
      width: 28px;
      height: 28px;
    }

    @media (max-width: 768px) {
      .tool-btn svg {
        width: 24px;
        height: 24px;
      }
    }

    .canvas-container {
      flex: 1;
      position: relative;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #whiteboard {
      background: white;
      box-shadow: 0 0 20px rgba(0,0,0,0.1);
      cursor: crosshair;
      border-radius: 8px;
      touch-action: none;
    }

    /* ç§»åŠ¨ç«¯ç”»å¸ƒä¼˜åŒ– */
    @media (max-width: 768px) {
      #whiteboard {
        max-width: 95vw;
        max-height: 70vh;
        width: auto;
        height: auto;
      }
    }

    .color-picker {
      width: 60px;
      height: 60px;
      margin: 8px;
      border: 3px solid #ddd;
      border-radius: 12px;
      cursor: pointer;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    @media (max-width: 768px) {
      .color-picker {
        width: 50px;
        height: 50px;
        margin: 5px;
        border-radius: 10px;
      }
    }

    .color-picker input {
      width: 100%;
      height: 100%;
      border: none;
      cursor: pointer;
      transform: scale(1.5);
    }

    .slider-container {
      margin: 15px 0;
      padding: 0 15px;
      text-align: center;
    }

    @media (max-width: 768px) {
      .slider-container {
        margin: 10px 0;
        padding: 0 10px;
      }
    }

    .slider {
      width: 60px;
      -webkit-appearance: none;
      height: 6px;
      border-radius: 6px;
      background: #ddd;
      outline: none;
    }

    @media (max-width: 768px) {
      .slider {
        width: 50px;
        height: 5px;
      }
    }

    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #4CAF50;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }

    @media (max-width: 768px) {
      .slider::-webkit-slider-thumb {
        width: 16px;
        height: 16px;
      }
    }

    .separator {
      width: 60px;
      height: 1px;
      background: #ddd;
      margin: 15px 0;
    }

    @media (max-width: 768px) {
      .separator {
        width: 50px;
        margin: 10px 0;
      }
    }

    .properties-panel {
      position: fixed;
      top: 20px;
      right: 20px;
      background: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 0 20px rgba(0,0,0,0.1);
      min-width: 250px;
      display: none;
      z-index: 200;
      border: 1px solid #e0e0e0;
    }

    /* ç§»åŠ¨ç«¯å±æ€§é¢æ¿ */
    @media (max-width: 768px) {
      .properties-panel {
        top: 10px;
        right: 10px;
        left: 10px;
        min-width: auto;
        padding: 15px;
      }
    }

    .properties-panel.show {
      display: block;
    }

    .property-group {
      margin-bottom: 20px;
    }

    .property-label {
      font-size: 14px;
      color: #666;
      margin-bottom: 8px;
      display: block;
      font-weight: 500;
    }

    .property-input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }

    .file-upload-area {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 300px;
      height: 200px;
      border: 3px dashed #4CAF50;
      border-radius: 20px;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(255,255,255,0.95);
      z-index: 300;
      backdrop-filter: blur(10px);
    }

    @media (max-width: 768px) {
      .file-upload-area {
        width: 90vw;
        height: 150px;
      }
    }

    .file-upload-area.drag-over {
      background: rgba(76, 175, 80, 0.1);
      border-color: #2E7D32;
    }

    .file-upload-area.show {
      display: flex;
    }

    .tooltip {
      position: absolute;
      background: #333;
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 13px;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s;
      white-space: nowrap;
      z-index: 400;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    .tool-btn:hover .tooltip {
      opacity: 1;
    }

    .shape-menu {
      position: absolute;
      top: 0;
      left: 70px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      padding: 8px;
      display: none;
      z-index: 150;
      border: 1px solid #e0e0e0;
    }

    @media (max-width: 768px) {
      .shape-menu {
        left: 50%;
        transform: translateX(-50%);
        bottom: 90px;
        top: auto;
      }
    }

    .shape-menu.show {
      display: flex;
      flex-direction: column;
    }

    .shape-option {
      width: 50px;
      height: 50px;
      margin: 4px;
      border: none;
      background: #f0f0f0;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .shape-option:hover {
      background: #e0e0e0;
      transform: scale(1.05);
    }

    .export-menu {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: white;
      padding: 15px;
      border-radius: 15px;
      box-shadow: 0 0 20px rgba(0,0,0,0.1);
      display: none;
      z-index: 200;
      border: 1px solid #e0e0e0;
    }

    @media (max-width: 768px) {
      .export-menu {
        bottom: 100px;
        right: 10px;
        left: 10px;
        padding: 12px;
      }
    }

    .export-menu.show {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .export-btn {
      padding: 10px 18px;
      border: none;
      background: #4CAF50;
      color: white;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    .export-btn:hover {
      background: #45a049;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    #fileInput {
      display: none;
    }

    .text-input {
      position: absolute;
      border: 2px dashed #4CAF50;
      background: rgba(255,255,255,0.95);
      padding: 8px;
      font-family: Arial, sans-serif;
      font-size: 16px;
      outline: none;
      display: none;
      z-index: 250;
      border-radius: 6px;
      min-width: 100px;
    }

    .text-input.show {
      display: block;
    }

    /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
    .mobile-controls {
      display: none;
    }

    @media (max-width: 768px) {
      .mobile-controls {
        display: flex;
        position: fixed;
        top: 10px;
        left: 10px;
        gap: 10px;
        z-index: 150;
      }
      
      .mobile-btn {
        width: 40px;
        height: 40px;
        border: none;
        background: rgba(255,255,255,0.9);
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        backdrop-filter: blur(10px);
      }
      
      .mobile-btn svg {
        width: 20px;
        height: 20px;
      }
    }

    /* è§¦æ‘¸æ‰‹åŠ¿æç¤º */
    .touch-hint {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 20px;
      border-radius: 15px;
      text-align: center;
      display: none;
      z-index: 500;
      max-width: 300px;
    }

    .touch-hint.show {
      display: block;
    }

    /* ç”»å¸ƒç½‘æ ¼èƒŒæ™¯ */
    .canvas-grid {
      background-image: 
        linear-gradient(rgba(0,0,0,0.1) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0,0,0,0.1) 1px, transparent 1px);
      background-size: 20px 20px;
    }

    /* å“åº”å¼å­—ä½“ */
    @media (max-width: 768px) {
      .tool-btn {
        font-size: 12px;
      }
    }
  </style>
</head>
<body>
  <div class="whiteboard-container">
    <!-- ç§»åŠ¨ç«¯æ§åˆ¶æŒ‰é’® -->
    <div class="mobile-controls">
      <button class="mobile-btn" id="clearBtn" title="æ¸…ç©ºç”»å¸ƒ">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M19 13H5v-2h14v2z"/>
        </svg>
      </button>
      <button class="mobile-btn" id="undoBtn" title="æ’¤é”€">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M12.5 8c-2.65 0-5.05.99-6.9 2.6L2 7v9h9l-3.62-3.62c1.39-1.16 3.16-1.88 5.12-1.88 3.54 0 6.55 2.31 7.6 5.5l2.37-.78C21.08 11.03 17.15 8 12.5 8z"/>
        </svg>
      </button>
      <button class="mobile-btn" id="redoBtn" title="é‡åš">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M18.4 10.6C16.55 8.99 14.15 8 11.5 8c-4.65 0-8.58 3.03-9.96 7.22L3.9 16c1.05-3.19 4.05-5.5 7.6-5.5 1.95 0 3.73.72 5.12 1.88L19 16V7l-3.6 3.6z"/>
        </svg>
      </button>
    </div>

    <div class="toolbar">
      <!-- ç”»ç¬”å·¥å…· -->
      <button class="tool-btn active" data-tool="pen" title="ç”»ç¬”">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
        </svg>
      </button>

      <!-- å½¢çŠ¶å·¥å…· -->
      <button class="tool-btn" data-tool="shapes" title="å½¢çŠ¶">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M19 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.11 0 2-.9 2-2V5c0-1.1-.89-2-2-2zm0 16H5V5h14v14z"/>
        </svg>
        <div class="shape-menu" id="shapeMenu">
          <button class="shape-option" data-shape="rect" title="çŸ©å½¢">â–¡</button>
          <button class="shape-option" data-shape="circle" title="åœ†å½¢">â—‹</button>
          <button class="shape-option" data-shape="line" title="ç›´çº¿">/</button>
          <button class="shape-option" data-shape="arrow" title="ç®­å¤´">â†’</button>
        </div>
      </button>

      <!-- æ–‡å­—å·¥å…· -->
      <button class="tool-btn" data-tool="text" title="æ·»åŠ æ–‡å­—">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M2.5 4v3h5v12h3V7h5V4H2.5zM21.5 9h-9v3h3v7h3v-7h3V9z"/>
        </svg>
      </button>

      <!-- æ©¡çš®æ“¦ -->
      <button class="tool-btn" data-tool="eraser" title="æ©¡çš®æ“¦">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M15.14 3C14.63 2 13.89 1.5 13 1.5S11.37 2 10.86 3L3 10.86C2 11.37 1.5 12.11 1.5 13S2 14.63 3 15.14L10.86 23C11.37 24 12.11 24.5 13 24.5S14.63 24 15.14 23L23 15.14C24 14.63 24.5 13.89 24.5 13S24 11.37 23 10.86L15.14 3z"/>
        </svg>
      </button>

      <div class="separator"></div>

      <!-- é¢œè‰²é€‰æ‹©å™¨ -->
      <div class="color-picker">
        <input type="color" id="colorPicker" value="#000000">
      </div>

      <!-- ç”»ç¬”ç²—ç»† -->
      <div class="slider-container">
        <input type="range" id="brushSize" class="slider" min="1" max="50" value="5">
        <div class="property-label">ç²—ç»†</div>
      </div>

      <div class="separator"></div>

      <!-- å›¾ç‰‡ä¸Šä¼  -->
      <button class="tool-btn" data-tool="image" title="ä¸Šä¼ å›¾ç‰‡">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
        </svg>
      </button>

      <!-- å¯¼å‡º -->
      <button class="tool-btn" data-tool="export" title="å¯¼å‡º">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
        </svg>
        <div class="export-menu" id="exportMenu">
          <button class="export-btn" onclick="exportCanvas('png')">PNG</button>
          <button class="export-btn" onclick="exportCanvas('jpg')">JPG</button>
          <button class="export-btn" onclick="exportCanvas('svg')">SVG</button>
        </div>
      </button>

      <!-- è®¾ç½® -->
      <button class="tool-btn" data-tool="settings" title="è®¾ç½®">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/>
        </svg>
      </button>
    </div>

    <div class="canvas-container">
      <canvas id="whiteboard" class="canvas-grid" width="800" height="600"></canvas>
    </div>

    <!-- å±æ€§é¢æ¿ -->
    <div class="properties-panel" id="propertiesPanel">
      <h3 style="margin-top: 0;">ç”»å¸ƒè®¾ç½®</h3>
      
      <div class="property-group">
        <label class="property-label">ç”»å¸ƒå®½åº¦</label>
        <input type="number" id="canvasWidth" class="property-input" value="800" min="100" max="2000">
      </div>
      
      <div class="property-group">
        <label class="property-label">ç”»å¸ƒé«˜åº¦</label>
        <input type="number" id="canvasHeight" class="property-input" value="600" min="100" max="2000">
      </div>
      
      <div class="property-group">
        <label class="property-label">èƒŒæ™¯ç½‘æ ¼</label>
        <input type="checkbox" id="showGrid" checked>
      </div>
      
      <button class="export-btn" onclick="resizeCanvas()" style="width: 100%;">åº”ç”¨è®¾ç½®</button>
    </div>

    <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
    <div class="file-upload-area" id="fileUploadArea">
      <div style="text-align: center;">
        <div style="font-size: 48px; margin-bottom: 10px;">ğŸ“</div>
        <div>æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„æˆ–ç‚¹å‡»ä¸Šä¼ </div>
      </div>
    </div>

    <!-- è§¦æ‘¸æ‰‹åŠ¿æç¤º -->
    <div class="touch-hint" id="touchHint">
      <h3>è§¦æ‘¸æ‰‹åŠ¿è¯´æ˜</h3>
      <p>â€¢ å•æŒ‡ç»˜åˆ¶</p>
      <p>â€¢ åŒæŒ‡ç¼©æ”¾ç”»å¸ƒ</p>
      <p>â€¢ ä¸‰æŒ‡ç§»åŠ¨ç”»å¸ƒ</p>
      <button onclick="document.getElementById('touchHint').classList.remove('show')" style="margin-top: 15px; padding: 8px 16px; background: #4CAF50; color: white; border: none; border-radius: 6px; cursor: pointer;">çŸ¥é“äº†</button>
    </div>

    <input type="file" id="fileInput" accept="image/*">
    <input type="text" class="text-input" id="textInput" placeholder="è¾“å…¥æ–‡å­—...">
  </div>

  <script>
    const canvas = document.getElementById('whiteboard');
    const ctx = canvas.getContext('2d');
    
    let isDrawing = false;
    let currentTool = 'pen';
    let currentColor = '#000000';
    let brushSize = 5;
    let lastX = 0;
    let lastY = 0;
    let history = [];
    let historyIndex = -1;
    let isPanning = false;
    let panStartX = 0;
    let panStartY = 0;
    let scale = 1;
    let offsetX = 0;
    let offsetY = 0;
    
    // è§¦æ‘¸ç›¸å…³å˜é‡
    let touchStartDistance = 0;
    let touchStartScale = 1;
    let touchStartOffsetX = 0;
    let touchStartOffsetY = 0;
    
    // åˆå§‹åŒ–
    function init() {
      // è®¾ç½®ç”»å¸ƒæ ·å¼
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      ctx.strokeStyle = currentColor;
      ctx.lineWidth = brushSize;
      
      // ä¿å­˜åˆå§‹çŠ¶æ€
      saveState();
      
      // æ˜¾ç¤ºè§¦æ‘¸æç¤ºï¼ˆä»…åœ¨ç§»åŠ¨ç«¯ï¼‰
      if (window.innerWidth <= 768) {
        setTimeout(() => {
          document.getElementById('touchHint').classList.add('show');
        }, 1000);
      }
    }
    
    // ä¿å­˜çŠ¶æ€
    function saveState() {
      const imageData = canvas.toDataURL();
      history = history.slice(0, historyIndex + 1);
      history.push(imageData);
      historyIndex = history.length - 1;
    }
    
    // æ¸…ç©ºç”»å¸ƒ
    function clearCanvas() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      saveState();
    }
    
    // æ’¤é”€
    function undo() {
      if (historyIndex > 0) {
        historyIndex--;
        const img = new Image();
        img.src = history[historyIndex];
        img.onload = function() {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.drawImage(img, 0, 0);
        };
      }
    }
    
    // é‡åš
    function redo() {
      if (historyIndex < history.length - 1) {
        historyIndex++;
        const img = new Image();
        img.src = history[historyIndex];
        img.onload = function() {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.drawImage(img, 0, 0);
        };
      }
    }
    
    // å·¥å…·åˆ‡æ¢
    document.querySelectorAll('.tool-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const tool = this.dataset.tool;
        
        // ç§»é™¤æ‰€æœ‰æ´»åŠ¨çŠ¶æ€
        document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
        
        // æ·»åŠ æ´»åŠ¨çŠ¶æ€
        this.classList.add('active');
        
        // è®¾ç½®å½“å‰å·¥å…·
        currentTool = tool;
        
        // ç‰¹æ®Šå·¥å…·å¤„ç†
        if (tool === 'shapes') {
          const shapeMenu = document.getElementById('shapeMenu');
          shapeMenu.classList.toggle('show');
        } else if (tool === 'export') {
          const exportMenu = document.getElementById('exportMenu');
          exportMenu.classList.toggle('show');
        } else if (tool === 'settings') {
          const propertiesPanel = document.getElementById('propertiesPanel');
          propertiesPanel.classList.toggle('show');
        } else if (tool === 'image') {
          document.getElementById('fileInput').click();
        } else if (tool === 'text') {
          addText();
        }
        
        // éšè—å…¶ä»–èœå•
        if (tool !== 'shapes') {
          document.getElementById('shapeMenu').classList.remove('show');
        }
        if (tool !== 'export') {
          document.getElementById('exportMenu').classList.remove('show');
        }
        if (tool !== 'settings') {
          document.getElementById('propertiesPanel').classList.remove('show');
        }
      });
    });
    
    // å½¢çŠ¶é€‰æ‹©
    document.querySelectorAll('.shape-option').forEach(option => {
      option.addEventListener('click', function() {
        const shape = this.dataset.shape;
        currentTool = 'shape';
        currentShape = shape;
        document.getElementById('shapeMenu').classList.remove('show');
      });
    });
    
    // é¢œè‰²é€‰æ‹©å™¨
    document.getElementById('colorPicker').addEventListener('change', function(e) {
      currentColor = e.target.value;
      ctx.strokeStyle = currentColor;
    });
    
    // ç”»ç¬”ç²—ç»†
    document.getElementById('brushSize').addEventListener('input', function(e) {
      brushSize = parseInt(e.target.value);
      ctx.lineWidth = brushSize;
    });
    
    // é¼ æ ‡äº‹ä»¶
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseout', stopDrawing);
    
    // è§¦æ‘¸äº‹ä»¶
    canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
    canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
    canvas.addEventListener('touchend', handleTouchEnd, { passive: false });
    
    function startDrawing(e) {
      if (currentTool === 'pen' || currentTool === 'eraser') {
        isDrawing = true;
        const rect = canvas.getBoundingClientRect();
        lastX = (e.clientX - rect.left - offsetX) / scale;
        lastY = (e.clientY - rect.top - offsetY) / scale;
      }
    }
    
    function draw(e) {
      if (!isDrawing) return;
      
      const rect = canvas.getBoundingClientRect();
      const currentX = (e.clientX - rect.left - offsetX) / scale;
      const currentY = (e.clientY - rect.top - offsetY) / scale;
      
      if (currentTool === 'pen') {
        ctx.strokeStyle = currentColor;
        ctx.lineWidth = brushSize;
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(currentX, currentY);
        ctx.stroke();
      } else if (currentTool === 'eraser') {
        ctx.strokeStyle = '#ffffff';
        ctx.lineWidth = brushSize * 2;
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(currentX, currentY);
        ctx.stroke();
      }
      
      lastX = currentX;
      lastY = currentY;
    }
    
    function stopDrawing() {
      if (isDrawing) {
        isDrawing = false;
        saveState();
      }
    }
    
    // è§¦æ‘¸äº‹ä»¶å¤„ç†
    function handleTouchStart(e) {
      e.preventDefault();
      
      if (e.touches.length === 1) {
        // å•æŒ‡ç»˜åˆ¶
        const touch = e.touches[0];
        const rect = canvas.getBoundingClientRect();
        lastX = (touch.clientX - rect.left - offsetX) / scale;
        lastY = (touch.clientY - rect.top - offsetY) / scale;
        isDrawing = true;
      } else if (e.touches.length === 2) {
        // åŒæŒ‡ç¼©æ”¾
        const touch1 = e.touches[0];
        const touch2 = e.touches[1];
        touchStartDistance = Math.sqrt(
          Math.pow(touch2.clientX - touch1.clientX, 2) +
          Math.pow(touch2.clientY - touch1.clientY, 2)
        );
        touchStartScale = scale;
      } else if (e.touches.length === 3) {
        // ä¸‰æŒ‡ç§»åŠ¨
        const touch = e.touches[0];
        panStartX = touch.clientX - offsetX;
        panStartY = touch.clientY - offsetY;
        isPanning = true;
      }
    }
    
    function handleTouchMove(e) {
      e.preventDefault();
      
      if (e.touches.length === 1 && isDrawing) {
        // å•æŒ‡ç»˜åˆ¶
        const touch = e.touches[0];
        const rect = canvas.getBoundingClientRect();
        const currentX = (touch.clientX - rect.left - offsetX) / scale;
        const currentY = (touch.clientY - rect.top - offsetY) / scale;
        
        if (currentTool === 'pen') {
          ctx.strokeStyle = currentColor;
          ctx.lineWidth = brushSize;
          ctx.beginPath();
          ctx.moveTo(lastX, lastY);
          ctx.lineTo(currentX, currentY);
          ctx.stroke();
        } else if (currentTool === 'eraser') {
          ctx.strokeStyle = '#ffffff';
          ctx.lineWidth = brushSize * 2;
          ctx.beginPath();
          ctx.moveTo(lastX, lastY);
          ctx.lineTo(currentX, currentY);
          ctx.stroke();
        }
        
        lastX = currentX;
        lastY = currentY;
      } else if (e.touches.length === 2) {
        // åŒæŒ‡ç¼©æ”¾
        const touch1 = e.touches[0];
        const touch2 = e.touches[1];
        const distance = Math.sqrt(
          Math.pow(touch2.clientX - touch1.clientX, 2) +
          Math.pow(touch2.clientY - touch1.clientY, 2)
        );
        
        const newScale = touchStartScale * (distance / touchStartDistance);
        scale = Math.max(0.5, Math.min(3, newScale));
        
        // æ›´æ–°ç”»å¸ƒå˜æ¢
        updateCanvasTransform();
      } else if (e.touches.length === 3 && isPanning) {
        // ä¸‰æŒ‡ç§»åŠ¨
        const touch = e.touches[0];
        offsetX = touch.clientX - panStartX;
        offsetY = touch.clientY - panStartY;
        
        // æ›´æ–°ç”»å¸ƒå˜æ¢
        updateCanvasTransform();
      }
    }
    
    function handleTouchEnd(e) {
      if (e.touches.length === 0) {
        if (isDrawing) {
          isDrawing = false;
          saveState();
        }
        if (isPanning) {
          isPanning = false;
        }
      }
    }
    
    // æ›´æ–°ç”»å¸ƒå˜æ¢
    function updateCanvasTransform() {
      canvas.style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${scale})`;
    }
    
    // æ·»åŠ æ–‡å­—
    function addText() {
      const textInput = document.getElementById('textInput');
      textInput.style.display = 'block';
      textInput.style.left = '50%';
      textInput.style.top = '50%';
      textInput.style.transform = 'translate(-50%, -50%)';
      textInput.focus();
      
      textInput.addEventListener('blur', function() {
        if (this.value.trim()) {
          const rect = canvas.getBoundingClientRect();
          const x = (rect.width / 2 - offsetX) / scale;
          const y = (rect.height / 2 - offsetY) / scale;
          
          ctx.font = `${brushSize * 3}px Arial`;
          ctx.fillStyle = currentColor;
          ctx.fillText(this.value, x, y);
          saveState();
        }
        this.style.display = 'none';
        this.value = '';
      });
    }
    
    // å›¾ç‰‡ä¸Šä¼ å¤„ç†
    document.getElementById('fileInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(event) {
          const img = new Image();
          img.onload = function() {
            const rect = canvas.getBoundingClientRect();
            const x = (rect.width / 2 - offsetX) / scale - img.width / 2;
            const y = (rect.height / 2 - offsetY) / scale - img.height / 2;
            
            ctx.drawImage(img, x, y);
            saveState();
          };
          img.src = event.target.result;
        };
        reader.readAsDataURL(file);
      }
    });
    
    // æ‹–æ‹½ä¸Šä¼ 
    let dragCounter = 0;
    
    document.addEventListener('dragenter', function(e) {
      e.preventDefault();
      dragCounter++;
      document.getElementById('fileUploadArea').classList.add('show');
    });
    
    document.addEventListener('dragleave', function(e) {
      e.preventDefault();
      dragCounter--;
      if (dragCounter === 0) {
        document.getElementById('fileUploadArea').classList.remove('show', 'drag-over');
      }
    });
    
    document.addEventListener('dragover', function(e) {
      e.preventDefault();
      document.getElementById('fileUploadArea').classList.add('drag-over');
    });
    
    document.addEventListener('drop', function(e) {
      e.preventDefault();
      dragCounter = 0;
      document.getElementById('fileUploadArea').classList.remove('show', 'drag-over');
      
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        document.getElementById('fileInput').files = files;
        document.getElementById('fileInput').dispatchEvent(new Event('change'));
      }
    });
    
    // ç§»åŠ¨ç«¯æŒ‰é’®äº‹ä»¶
    document.getElementById('clearBtn').addEventListener('click', clearCanvas);
    document.getElementById('undoBtn').addEventListener('click', undo);
    document.getElementById('redoBtn').addEventListener('click', redo);
    
    // å¯¼å‡ºåŠŸèƒ½
    function exportCanvas(format) {
      const link = document.createElement('a');
      const timestamp = new Date().toISOString().slice(0, 19).replace(/[:]/g, '-');
      
      if (format === 'png' || format === 'jpg') {
        link.download = `whiteboard-${timestamp}.${format}`;
        link.href = canvas.toDataURL(`image/${format === 'jpg' ? 'jpeg' : 'png'}`);
      } else if (format === 'svg') {
        // SVG å¯¼å‡ºéœ€è¦æ›´å¤æ‚çš„å®ç°
        alert('SVG å¯¼å‡ºåŠŸèƒ½å³å°†æ¨å‡º!');
        return;
      }
      
      link.click();
      document.getElementById('exportMenu').classList.remove('show');
    }
    
    // è°ƒæ•´ç”»å¸ƒå¤§å°
    function resizeCanvas() {
      const width = parseInt(document.getElementById('canvasWidth').value);
      const height = parseInt(document.getElementById('canvasHeight').value);
      
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      canvas.width = width;
      canvas.height = height;
      ctx.putImageData(imageData, 0, 0);
      
      saveState();
    }
    
    // èƒŒæ™¯ç½‘æ ¼åˆ‡æ¢
    document.getElementById('showGrid').addEventListener('change', function(e) {
      if (e.target.checked) {
        canvas.classList.add('canvas-grid');
      } else {
        canvas.classList.remove('canvas-grid');
      }
    });
    
    // é”®ç›˜å¿«æ·é”®
    document.addEventListener('keydown', function(e) {
      if (e.ctrlKey || e.metaKey) {
        switch(e.key) {
          case 'z':
            e.preventDefault();
            undo();
            break;
          case 'y':
            e.preventDefault();
            redo();
            break;
          case 's':
            e.preventDefault();
            exportCanvas('png');
            break;
        }
      }
    });
    
    // ç‚¹å‡»å¤–éƒ¨å…³é—­èœå•
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.tool-btn[data-tool="shapes"]') && !e.target.closest('.shape-menu')) {
        document.getElementById('shapeMenu').classList.remove('show');
      }
      if (!e.target.closest('.tool-btn[data-tool="export"]') && !e.target.closest('.export-menu')) {
        document.getElementById('exportMenu').classList.remove('show');
      }
      if (!e.target.closest('.tool-btn[data-tool="settings"]') && !e.target.closest('.properties-panel')) {
        document.getElementById('propertiesPanel').classList.remove('show');
      }
    });
    
    // çª—å£å¤§å°è°ƒæ•´
    window.addEventListener('resize', function() {
      // é‡æ–°è®¡ç®—ç”»å¸ƒä½ç½®
      updateCanvasTransform();
    });
    
    // åˆå§‹åŒ–
    init();
  </script>
</body>
</html>
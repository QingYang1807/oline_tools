<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mermaid 可视化渲染器 V3 - 功能全集版</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.9.1/dist/mermaid.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prettier@3/standalone.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prettier@3/parser-babel.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .version-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
            min-height: 700px;
        }

        .editor-panel {
            padding: 30px;
            background: #f8f9fa;
            border-right: 1px solid #e9ecef;
        }

        .preview-panel {
            padding: 30px;
            background: white;
            position: relative;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
            font-size: 1.1em;
        }

        /* 主题选择器样式 - 来自V1 */
        .theme-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            border: 1px solid #e9ecef;
        }

        .theme-selector label {
            font-weight: 500;
            color: #495057;
            white-space: nowrap;
            margin-bottom: 0;
            font-size: 1em;
        }

        .theme-selector select {
            appearance: none;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            color: #495057;
            padding: 8px 32px 8px 12px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 8px center;
            background-repeat: no-repeat;
            background-size: 16px;
        }

        .theme-selector select:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .theme-selector select:hover {
            border-color: #4facfe;
        }

        /* 图片质量选择器 - 来自V3 */
        .quality-selector {
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            border: 1px solid #e9ecef;
        }

        .quality-selector label {
            margin-bottom: 10px;
            font-size: 1em;
        }

        .quality-options {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .quality-option {
            padding: 8px 16px;
            border: 2px solid #e9ecef;
            border-radius: 20px;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }

        .quality-option:hover {
            border-color: #4facfe;
            background: #f0f8ff;
        }

        .quality-option.active {
            border-color: #4facfe;
            background: #4facfe;
            color: white;
        }

        textarea {
            width: 100%;
            min-height: 400px;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            line-height: 1.5;
            resize: vertical;
            transition: border-color 0.3s ease;
        }

        textarea:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(79, 172, 254, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(86, 171, 47, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(245, 87, 108, 0.3);
        }

        .preview-container {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            min-height: 400px;
            position: relative;
            overflow: auto;
        }

        #mermaidContainer {
            width: 100%;
            height: auto;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
        }

        #mermaidContainer svg {
            max-width: 100%;
            height: auto;
            shape-rendering: geometricPrecision;
            text-rendering: geometricPrecision;
            image-rendering: -webkit-optimize-contrast;
        }

        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
            display: none;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .examples {
            margin-top: 20px;
        }

        .example-btn {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            color: #495057;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.9em;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s ease;
        }

        .example-btn:hover {
            background: #e9ecef;
            transform: translateY(-1px);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4facfe;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .copy-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .copy-notification.show {
            transform: translateX(0);
        }

        /* 全屏模态框样式 - 来自V2 */
        .fullscreen-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            flex-direction: column;
        }

        .fullscreen-modal.show {
            display: flex;
        }

        .modal-header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.2em;
            font-weight: 500;
        }

        .modal-controls {
            display: flex;
            gap: 10px;
        }

        .control-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .modal-content {
            flex: 1;
            overflow: hidden;
            position: relative;
            background: white;
        }

        .fullscreen-container {
            width: 100%;
            height: 100%;
            overflow: auto;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            cursor: grab;
            transition: transform 0.1s ease;
        }

        .fullscreen-container:active {
            cursor: grabbing;
        }

        .fullscreen-container svg {
            max-width: none;
            max-height: none;
            transition: transform 0.3s ease;
            transform-origin: center center;
        }

        .zoom-info {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.9em;
            font-weight: 500;
            backdrop-filter: blur(10px);
        }

        .fullscreen-container.dragging {
            cursor: grabbing;
        }

        /* 历史记录模态框样式 - 来自V1 */
        .history-modal {
            display: none;
            position: fixed;
            z-index: 1500;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        .history-modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .history-modal-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            width: 90%;
            max-width: 900px;
            max-height: 80vh;
            overflow: hidden;
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .history-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid #e9ecef;
            background: #f8f9fa;
        }

        .history-modal-header h2 {
            margin: 0;
            font-size: 1.5em;
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6c757d;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .close-btn:hover {
            background: #e9ecef;
            color: #333;
        }

        .history-modal-body {
            padding: 24px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .history-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .danger-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s ease;
        }

        .danger-btn:hover {
            background: #c82333;
        }

        .history-count {
            color: #6c757d;
            font-size: 14px;
        }

        .history-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }

        .history-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 16px;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .history-item:hover {
            border-color: #4facfe;
            box-shadow: 0 2px 8px rgba(79, 172, 254, 0.1);
        }

        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
            gap: 12px;
        }

        .history-item-title {
            font-weight: 600;
            color: #333;
            font-size: 16px;
            margin: 0;
            flex: 1;
            word-break: break-word;
        }

        .history-item-time {
            color: #6c757d;
            font-size: 12px;
            white-space: nowrap;
        }

        .history-item-preview {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 12px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 12px;
            color: #6c757d;
            max-height: 80px;
            overflow: hidden;
            position: relative;
        }

        .history-item-preview::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 20px;
            background: linear-gradient(transparent, white);
        }

        .history-item-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .history-btn {
            padding: 6px 12px;
            border: 1px solid #e9ecef;
            background: white;
            color: #333;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .history-btn:hover {
            background: #f8f9fa;
            border-color: #4facfe;
        }

        .history-btn.primary {
            background: #4facfe;
            color: white;
            border-color: #4facfe;
        }

        .history-btn.primary:hover {
            background: #3b8bdb;
        }

        .history-btn.danger {
            background: #dc3545;
            color: white;
            border-color: #dc3545;
        }

        .history-btn.danger:hover {
            background: #c82333;
        }

        .empty-history {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }

        .empty-history-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .editor-panel {
                border-right: none;
                border-bottom: 1px solid #e9ecef;
            }

            .modal-controls {
                gap: 5px;
            }

            .control-btn {
                padding: 6px 10px;
                font-size: 0.9em;
            }

            .modal-header h3 {
                font-size: 1em;
            }

            .history-modal-content {
                width: 95%;
                max-height: 90vh;
                margin: 20px;
            }

            .history-modal-header {
                padding: 16px 20px;
            }

            .history-modal-body {
                padding: 20px;
            }

            .history-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .history-list {
                grid-template-columns: 1fr;
            }

            .button-group {
                flex-direction: column;
            }

            .quality-options {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="version-badge">V3 功能全集版</div>
            <h1>🎨 Mermaid 可视化渲染器 V3</h1>
            <p>集成所有版本的强大功能：主题切换、质量选择、全屏查看、历史记录、URL分享等</p>
        </div>

        <div class="main-content">
            <div class="editor-panel">
                <!-- 主题选择器 - 来自V1 -->
                <div class="theme-selector">
                    <label for="theme">渲染主题</label>
                    <select id="theme">
                        <option value="default">默认</option>
                        <option value="neutral">中性</option>
                        <option value="dark">深色</option>
                        <option value="forest">森林</option>
                        <option value="base">基础</option>
                    </select>
                </div>

                <!-- 图片质量选择器 - 来自V3 -->
                <div class="quality-selector">
                    <label>导出质量</label>
                    <div class="quality-options">
                        <div class="quality-option" data-quality="standard" onclick="setQuality('standard')">标准 (2x)</div>
                        <div class="quality-option active" data-quality="high" onclick="setQuality('high')">高清 (4x)</div>
                        <div class="quality-option" data-quality="ultra" onclick="setQuality('ultra')">超高清 (8x)</div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="mermaidCode">Mermaid 代码编辑器</label>
                    <textarea id="mermaidCode" placeholder="在此输入您的 Mermaid 代码...">graph TD
    A[开始] --> B{是否登录?}
    B -->|是| C[显示主页]
    B -->|否| D[显示登录页]
    D --> E[用户登录]
    E --> F{登录成功?}
    F -->|是| C
    F -->|否| G[显示错误信息]
    G --> D
    C --> H[结束]</textarea>
                </div>

                <div class="examples">
                    <label>快速示例：</label>
                    <button class="example-btn" onclick="loadExample('flowchart')">流程图</button>
                    <button class="example-btn" onclick="loadExample('sequence')">时序图</button>
                    <button class="example-btn" onclick="loadExample('gantt')">甘特图</button>
                    <button class="example-btn" onclick="loadExample('pie')">饼图</button>
                    <button class="example-btn" onclick="loadExample('mindmap')">思维导图</button>
                    <button class="example-btn" onclick="loadExample('class')">类图</button>
                    <button class="example-btn" onclick="loadExample('state')">状态图</button>
                </div>

                <div class="button-group">
                    <button class="btn btn-primary" onclick="renderMermaid()">
                        <span>🔄</span> 渲染图表
                    </button>
                    <button class="btn btn-success" onclick="copyAsImage()">
                        <span>📋</span> 复制为图片
                    </button>
                    <button class="btn btn-secondary" onclick="downloadImage()">
                        <span>💾</span> 下载图片
                    </button>
                    <button class="btn btn-warning" onclick="formatCode()">
                        <span>✨</span> 格式化
                    </button>
                    <button class="btn btn-secondary" onclick="clearEditor()">
                        <span>🗑️</span> 清空
                    </button>
                    <button class="btn btn-secondary" onclick="showHistoryModal()">
                        <span>📚</span> 历史记录
                    </button>
                </div>

                <div id="statusMessage" class="status-message"></div>
            </div>

            <div class="preview-panel">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <label>实时预览</label>
                    <button class="btn btn-secondary" onclick="openFullscreen()" id="zoomBtn" style="padding: 8px 16px; font-size: 0.9em;" disabled>
                        <span>🔍</span> 放大查看
                    </button>
                </div>
                <div class="preview-container">
                    <div id="loading" class="loading">
                        <div class="spinner"></div>
                        <p>正在渲染图表...</p>
                    </div>
                    <div id="mermaidContainer"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="copyNotification" class="copy-notification">
        ✅ 图片已复制到剪贴板！
    </div>

    <!-- 全屏放大模态框 - 来自V2 -->
    <div id="fullscreenModal" class="fullscreen-modal">
        <div class="modal-header">
            <h3>🔍 图表放大查看</h3>
            <div class="modal-controls">
                <button class="control-btn" onclick="zoomIn()" title="放大">
                    <span>🔍+</span>
                </button>
                <button class="control-btn" onclick="zoomOut()" title="缩小">
                    <span>🔍-</span>
                </button>
                <button class="control-btn" onclick="resetZoom()" title="重置缩放">
                    <span>🔄</span>
                </button>
                <button class="control-btn" onclick="closeFullscreen()" title="关闭">
                    <span>❌</span>
                </button>
            </div>
        </div>
        <div class="modal-content">
            <div id="fullscreenContainer" class="fullscreen-container">
                <!-- 放大的图表将在这里显示 -->
            </div>
        </div>
        <div class="zoom-info">
            <span id="zoomLevel">100%</span>
        </div>
    </div>

    <!-- 历史记录模态框 - 来自V1 -->
    <div id="historyModal" class="history-modal">
        <div class="history-modal-content">
            <div class="history-modal-header">
                <h2>📚 历史记录管理</h2>
                <button class="close-btn" id="closeHistory">&times;</button>
            </div>
            <div class="history-modal-body">
                <div class="history-controls">
                    <button id="clearAllHistory" class="danger-btn">清空所有历史</button>
                    <span class="history-count">共 <span id="historyCount">0</span> 条记录</span>
                </div>
                <div id="historyList" class="history-list">
                    <!-- 历史记录将在这里动态生成 -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // 历史记录管理 - 来自V1
        const HISTORY_KEY = 'mermaid_history_v3';
        const MAX_HISTORY_ITEMS = 100; // 增加历史记录数量

        // 图片质量设置 - 来自V3
        let currentQuality = 'high';
        const qualitySettings = {
            standard: { scale: 2, quality: 0.9 },
            high: { scale: 4, quality: 0.95 },
            ultra: { scale: 8, quality: 1.0 }
        };

        // 全屏查看相关变量 - 来自V2
        let currentZoom = 1;
        let isDragging = false;
        let dragStart = { x: 0, y: 0 };
        let dragOffset = { x: 0, y: 0 };

        // 初始化 Mermaid - 合并所有版本的配置
        mermaid.initialize({
            startOnLoad: false,
            theme: 'default',
            themeVariables: {
                primaryColor: '#4facfe',
                primaryTextColor: '#333',
                primaryBorderColor: '#4facfe',
                lineColor: '#666',
                sectionBkgColor: '#f8f9fa',
                altSectionBkgColor: '#e9ecef',
                gridColor: '#dee2e6',
                secondaryColor: '#00f2fe',
                tertiaryColor: '#ffffff'
            },
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            },
            securityLevel: 'loose',
            maxTextSize: 90000,
            maxEdges: 500,
            svg: {
                fontFamily: 'Arial, sans-serif'
            }
        });

        // 示例代码 - 合并所有版本的示例
        const examples = {
            flowchart: `graph TD
    A[开始] --> B{是否登录?}
    B -->|是| C[显示主页]
    B -->|否| D[显示登录页]
    D --> E[用户登录]
    E --> F{登录成功?}
    F -->|是| C
    F -->|否| G[显示错误信息]
    G --> D
    C --> H[结束]`,
            
            sequence: `sequenceDiagram
    participant U as 用户
    participant F as 前端
    participant B as 后端
    participant D as 数据库
    
    U->>F: 登录请求
    F->>B: 验证用户信息
    B->>D: 查询用户数据
    D-->>B: 返回用户信息
    B-->>F: 返回验证结果
    F-->>U: 显示登录状态`,
            
            gantt: `gantt
    title 项目开发计划
    dateFormat  YYYY-MM-DD
    section 需求分析
    需求收集           :done,    des1, 2024-01-01,2024-01-05
    需求分析           :done,    des2, 2024-01-06, 3d
    section 设计阶段
    系统设计           :active,  des3, 2024-01-10, 5d
    界面设计           :         des4, after des3, 3d
    section 开发阶段
    后端开发           :         des5, 2024-01-20, 10d
    前端开发           :         des6, 2024-01-25, 8d
    测试               :         des7, 2024-02-05, 5d`,
            
            pie: `pie title 技术栈使用情况
    "JavaScript" : 35
    "Python" : 25
    "Java" : 20
    "Go" : 10
    "其他" : 10`,
            
            mindmap: `mindmap
  root((Mermaid 图表类型))
    流程图
      基础流程图
      子图
      样式
    时序图
      参与者
      消息
      激活
    甘特图
      任务
      里程碑
      依赖关系
    饼图
      数据展示
      百分比
    思维导图
      节点
      连接
      层级`,

            class: `classDiagram
    class Animal {
        +String name
        +int age
        +makeSound()
    }
    class Dog {
        +String breed
        +bark()
    }
    class Cat {
        +String color
        +meow()
    }
    
    Animal <|-- Dog
    Animal <|-- Cat`,

            state: `stateDiagram-v2
    [*] --> Still
    Still --> [*]
    
    Still --> Moving
    Moving --> Still
    Moving --> Crash
    Crash --> [*]`
        };

        function loadExample(type) {
            document.getElementById('mermaidCode').value = examples[type];
            renderMermaid();
        }

        function showStatus(message, type = 'success') {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = `status-message status-${type}`;
            statusEl.style.display = 'block';
            
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 3000);
        }

        function showLoading(show = true) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        // 设置图片质量 - 来自V3
        function setQuality(quality) {
            currentQuality = quality;
            
            document.querySelectorAll('.quality-option').forEach(option => {
                option.classList.remove('active');
            });
            document.querySelector(`[data-quality="${quality}"]`).classList.add('active');
            
            const settings = qualitySettings[quality];
            showStatus(`已切换到${quality === 'standard' ? '标准' : quality === 'high' ? '高清' : '超高清'}模式 (${settings.scale}x缩放)`, 'info');
        }

        // 渲染函数 - 合并所有版本的功能
        async function renderMermaid() {
            const code = document.getElementById('mermaidCode').value.trim();
            const container = document.getElementById('mermaidContainer');
            const theme = document.getElementById('theme').value || 'default';
            
            if (!code) {
                showStatus('请输入 Mermaid 代码', 'error');
                return;
            }

            showLoading(true);
            container.innerHTML = '';

            try {
                // 更新主题
                mermaid.initialize({
                    startOnLoad: false,
                    theme: theme,
                    themeVariables: {
                        primaryColor: '#4facfe',
                        primaryTextColor: '#333',
                        primaryBorderColor: '#4facfe',
                        lineColor: '#666',
                        sectionBkgColor: '#f8f9fa',
                        altSectionBkgColor: '#e9ecef',
                        gridColor: '#dee2e6',
                        secondaryColor: '#00f2fe',
                        tertiaryColor: '#ffffff'
                    },
                    flowchart: {
                        useMaxWidth: true,
                        htmlLabels: true,
                        curve: 'basis'
                    },
                    securityLevel: 'loose',
                    maxTextSize: 90000,
                    maxEdges: 500,
                    svg: {
                        fontFamily: 'Arial, sans-serif'
                    }
                });

                const id = 'mermaid-' + Date.now();
                const { svg } = await mermaid.render(id, code);
                container.innerHTML = svg;
                
                // 启用放大按钮
                document.getElementById('zoomBtn').disabled = false;
                
                // 保存到历史记录
                addToHistory(code, theme);
                
                // 保存到URL - 来自V1
                saveToHash();
                
                showStatus('图表渲染成功！', 'success');
            } catch (error) {
                console.error('Mermaid 渲染错误:', error);
                container.innerHTML = `<div style="color: #dc3545; padding: 20px; text-align: center;">
                    <h3>渲染错误</h3>
                    <p>${error.message}</p>
                    <p>请检查您的 Mermaid 语法是否正确。</p>
                </div>`;
                showStatus('渲染失败：' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // 复制为图片 - 来自V3的高质量版本
        async function copyAsImage() {
            const container = document.getElementById('mermaidContainer');
            
            if (!container.innerHTML || container.innerHTML.trim() === '') {
                showStatus('请先渲染图表', 'error');
                return;
            }

            try {
                showLoading(true);
                
                const settings = qualitySettings[currentQuality];
                const canvas = await html2canvas(container, {
                    backgroundColor: '#ffffff',
                    scale: settings.scale,
                    useCORS: true,
                    allowTaint: true,
                    width: container.scrollWidth,
                    height: container.scrollHeight,
                    logging: false,
                    foreignObjectRendering: true,
                    removeContainer: true
                });

                canvas.toBlob(async (blob) => {
                    try {
                        await navigator.clipboard.write([
                            new ClipboardItem({
                                'image/png': blob
                            })
                        ]);
                        
                        showCopyNotification();
                        showStatus('图片已复制到剪贴板！', 'success');
                    } catch (clipboardError) {
                        console.error('复制失败:', clipboardError);
                        showStatus('复制失败，请尝试下载图片', 'error');
                    }
                }, 'image/png', settings.quality);

            } catch (error) {
                console.error('生成图片失败:', error);
                showStatus('生成图片失败：' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // 下载图片 - 来自V3的高质量版本
        async function downloadImage() {
            const container = document.getElementById('mermaidContainer');
            
            if (!container.innerHTML || container.innerHTML.trim() === '') {
                showStatus('请先渲染图表', 'error');
                return;
            }

            try {
                showLoading(true);
                
                const settings = qualitySettings[currentQuality];
                const canvas = await html2canvas(container, {
                    backgroundColor: '#ffffff',
                    scale: settings.scale,
                    useCORS: true,
                    allowTaint: true,
                    width: container.scrollWidth,
                    height: container.scrollHeight,
                    logging: false,
                    foreignObjectRendering: true,
                    removeContainer: true
                });

                const link = document.createElement('a');
                link.download = `mermaid-diagram-${Date.now()}.png`;
                link.href = canvas.toDataURL('image/png', settings.quality);
                link.click();
                
                showStatus('图片下载成功！', 'success');
            } catch (error) {
                console.error('下载失败:', error);
                showStatus('下载失败：' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // 格式化代码 - 来自V1
        function formatCode() {
            const lines = document.getElementById('mermaidCode').value.split('\n');
            const cleaned = lines.map(l => l.replace(/\s+$/,'')).join('\n').trim() + '\n';
            document.getElementById('mermaidCode').value = cleaned;
            showStatus('代码已格式化', 'success');
        }

        // 清空编辑器 - 来自V1
        function clearEditor() {
            document.getElementById('mermaidCode').value = '';
            document.getElementById('mermaidContainer').innerHTML = '<em style="color: #6c757d;">请输入 Mermaid 代码</em>';
            document.getElementById('zoomBtn').disabled = true;
            location.hash = '';
            showStatus('编辑器已清空', 'info');
        }

        function showCopyNotification() {
            const notification = document.getElementById('copyNotification');
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 2000);
        }

        // 全屏查看功能 - 来自V2
        function openFullscreen() {
            const container = document.getElementById('mermaidContainer');
            const fullscreenContainer = document.getElementById('fullscreenContainer');
            
            if (!container.innerHTML || container.innerHTML.trim() === '') {
                showStatus('请先渲染图表', 'error');
                return;
            }

            // 复制图表内容到全屏容器
            fullscreenContainer.innerHTML = container.innerHTML;
            
            // 显示模态框
            const modal = document.getElementById('fullscreenModal');
            modal.classList.add('show');
            
            // 重置缩放和位置
            currentZoom = 1;
            dragOffset = { x: 0, y: 0 };
            updateZoom();
            
            // 添加拖拽事件监听
            addDragListeners();
            
            // 阻止背景滚动
            document.body.style.overflow = 'hidden';
        }

        function closeFullscreen() {
            const modal = document.getElementById('fullscreenModal');
            modal.classList.remove('show');
            
            // 恢复背景滚动
            document.body.style.overflow = 'auto';
            
            // 移除拖拽事件监听
            removeDragListeners();
        }

        // 放大
        function zoomIn() {
            currentZoom = Math.min(currentZoom * 1.2, 5);
            updateZoom();
        }

        // 缩小
        function zoomOut() {
            currentZoom = Math.max(currentZoom / 1.2, 0.1);
            updateZoom();
        }

        // 重置缩放
        function resetZoom() {
            currentZoom = 1;
            dragOffset = { x: 0, y: 0 };
            updateZoom();
        }

        // 更新缩放
        function updateZoom() {
            const svg = document.querySelector('#fullscreenContainer svg');
            const zoomLevel = document.getElementById('zoomLevel');
            
            if (svg) {
                svg.style.transform = `scale(${currentZoom}) translate(${dragOffset.x}px, ${dragOffset.y}px)`;
            }
            
            if (zoomLevel) {
                zoomLevel.textContent = Math.round(currentZoom * 100) + '%';
            }
        }

        // 添加拖拽事件监听
        function addDragListeners() {
            const container = document.getElementById('fullscreenContainer');
            
            container.addEventListener('mousedown', startDrag);
            container.addEventListener('mousemove', drag);
            container.addEventListener('mouseup', endDrag);
            container.addEventListener('mouseleave', endDrag);
            
            container.addEventListener('touchstart', startDragTouch);
            container.addEventListener('touchmove', dragTouch);
            container.addEventListener('touchend', endDrag);
        }

        // 移除拖拽事件监听
        function removeDragListeners() {
            const container = document.getElementById('fullscreenContainer');
            
            container.removeEventListener('mousedown', startDrag);
            container.removeEventListener('mousemove', drag);
            container.removeEventListener('mouseup', endDrag);
            container.removeEventListener('mouseleave', endDrag);
            
            container.removeEventListener('touchstart', startDragTouch);
            container.removeEventListener('touchmove', dragTouch);
            container.removeEventListener('touchend', endDrag);
        }

        // 开始拖拽
        function startDrag(e) {
            isDragging = true;
            dragStart.x = e.clientX - dragOffset.x;
            dragStart.y = e.clientY - dragOffset.y;
            document.getElementById('fullscreenContainer').classList.add('dragging');
            e.preventDefault();
        }

        // 拖拽中
        function drag(e) {
            if (!isDragging) return;
            
            dragOffset.x = e.clientX - dragStart.x;
            dragOffset.y = e.clientY - dragStart.y;
            updateZoom();
            e.preventDefault();
        }

        // 结束拖拽
        function endDrag() {
            isDragging = false;
            document.getElementById('fullscreenContainer').classList.remove('dragging');
        }

        // 触摸开始拖拽
        function startDragTouch(e) {
            if (e.touches.length === 1) {
                isDragging = true;
                dragStart.x = e.touches[0].clientX - dragOffset.x;
                dragStart.y = e.touches[0].clientY - dragOffset.y;
                document.getElementById('fullscreenContainer').classList.add('dragging');
                e.preventDefault();
            }
        }

        // 触摸拖拽中
        function dragTouch(e) {
            if (!isDragging || e.touches.length !== 1) return;
            
            dragOffset.x = e.touches[0].clientX - dragStart.x;
            dragOffset.y = e.touches[0].clientY - dragStart.y;
            updateZoom();
            e.preventDefault();
        }

        // 历史记录功能 - 来自V1
        function getHistory() {
            try {
                const history = localStorage.getItem(HISTORY_KEY);
                return history ? JSON.parse(history) : [];
            } catch (error) {
                console.error('获取历史记录失败:', error);
                return [];
            }
        }

        function saveHistory(history) {
            try {
                localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
            } catch (error) {
                console.error('保存历史记录失败:', error);
            }
        }

        function addToHistory(code, theme) {
            if (!code || code.trim() === '') return;
            
            const history = getHistory();
            const now = new Date();
            const timestamp = now.getTime();
            
            const existingIndex = history.findIndex(item => item.code === code);
            if (existingIndex !== -1) {
                history[existingIndex].timestamp = timestamp;
                history[existingIndex].theme = theme;
                const item = history.splice(existingIndex, 1)[0];
                history.unshift(item);
            } else {
                const title = generateTitle(code);
                const newItem = {
                    id: timestamp,
                    title: title,
                    code: code,
                    theme: theme,
                    timestamp: timestamp,
                    preview: code.substring(0, 200) + (code.length > 200 ? '...' : '')
                };
                history.unshift(newItem);
            }
            
            if (history.length > MAX_HISTORY_ITEMS) {
                history.splice(MAX_HISTORY_ITEMS);
            }
            
            saveHistory(history);
        }

        function generateTitle(code) {
            const lines = code.split('\n');
            const firstLine = lines[0].trim();
            
            if (firstLine.includes('flowchart') || firstLine.includes('graph')) {
                const nodeMatch = code.match(/\[([^\]]+)\]/);
                if (nodeMatch) {
                    return nodeMatch[1];
                }
            }
            
            if (firstLine.includes('sequenceDiagram')) {
                const participantMatch = code.match(/participant\s+(\w+)/i);
                if (participantMatch) {
                    return `时序图 - ${participantMatch[1]}`;
                }
            }
            
            if (firstLine.includes('gantt')) {
                return '甘特图';
            }
            
            if (firstLine.includes('pie')) {
                return '饼图';
            }
            
            if (firstLine.includes('mindmap')) {
                return '思维导图';
            }

            if (firstLine.includes('classDiagram')) {
                return '类图';
            }

            if (firstLine.includes('stateDiagram')) {
                return '状态图';
            }
            
            return firstLine.substring(0, 30) + (firstLine.length > 30 ? '...' : '');
        }

        function formatTime(timestamp) {
            const now = new Date();
            const date = new Date(timestamp);
            const diff = now - date;
            
            if (diff < 60000) {
                return '刚刚';
            } else if (diff < 3600000) {
                return `${Math.floor(diff / 60000)}分钟前`;
            } else if (diff < 86400000) {
                return `${Math.floor(diff / 3600000)}小时前`;
            } else if (diff < 604800000) {
                return `${Math.floor(diff / 86400000)}天前`;
            } else {
                return date.toLocaleDateString('zh-CN');
            }
        }

        function showHistoryModal() {
            const modal = document.getElementById('historyModal');
            modal.classList.add('show');
            loadHistoryList();
        }

        function hideHistoryModal() {
            const modal = document.getElementById('historyModal');
            modal.classList.remove('show');
        }

        function loadHistoryList() {
            const history = getHistory();
            const historyList = document.getElementById('historyList');
            const historyCount = document.getElementById('historyCount');
            
            historyCount.textContent = history.length;
            
            if (history.length === 0) {
                historyList.innerHTML = `
                    <div class="empty-history">
                        <div class="empty-history-icon">📚</div>
                        <p>暂无历史记录</p>
                        <p>开始创建图表后，历史记录将自动保存</p>
                    </div>
                `;
                return;
            }
            
            historyList.innerHTML = history.map(item => `
                <div class="history-item" data-id="${item.id}">
                    <div class="history-item-header">
                        <h3 class="history-item-title">${item.title}</h3>
                        <span class="history-item-time">${formatTime(item.timestamp)}</span>
                    </div>
                    <div class="history-item-preview">${item.preview}</div>
                    <div class="history-item-actions">
                        <button class="history-btn primary" onclick="loadHistoryItem('${item.id}')">
                            🔄 加载
                        </button>
                        <button class="history-btn" onclick="editHistoryItem('${item.id}')">
                            ✏️ 编辑
                        </button>
                        <button class="history-btn danger" onclick="deleteHistoryItem('${item.id}')">
                            🗑️ 删除
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function loadHistoryItem(id) {
            const history = getHistory();
            const item = history.find(h => h.id == id);
            if (item) {
                document.getElementById('mermaidCode').value = item.code;
                document.getElementById('theme').value = item.theme || 'default';
                hideHistoryModal();
                renderMermaid();
            }
        }

        function editHistoryItem(id) {
            const history = getHistory();
            const item = history.find(h => h.id == id);
            if (item) {
                document.getElementById('mermaidCode').value = item.code;
                document.getElementById('theme').value = item.theme || 'default';
                hideHistoryModal();
                renderMermaid();
                document.getElementById('mermaidCode').focus();
            }
        }

        function deleteHistoryItem(id) {
            if (confirm('确定要删除这条历史记录吗？')) {
                const history = getHistory();
                const filteredHistory = history.filter(h => h.id != id);
                saveHistory(filteredHistory);
                loadHistoryList();
            }
        }

        function clearAllHistory() {
            if (confirm('确定要清空所有历史记录吗？此操作不可恢复。')) {
                localStorage.removeItem(HISTORY_KEY);
                loadHistoryList();
            }
        }

        // URL Hash 同步功能 - 来自V1
        function saveToHash() {
            const theme = document.getElementById('theme').value;
            const encoded = encodeURIComponent(document.getElementById('mermaidCode').value);
            location.hash = `t=${theme}&c=${encoded}`;
        }

        function loadFromHash() {
            if (!location.hash) return;
            const raw = location.hash.slice(1);
            const params = new URLSearchParams(raw.replace(/&/g,'&'));
            const t = params.get('t');
            const c = params.get('c');
            if (t) document.getElementById('theme').value = t;
            if (c) document.getElementById('mermaidCode').value = decodeURIComponent(c);
        }

        // 事件绑定
        document.getElementById('theme').addEventListener('change', renderMermaid);
        document.getElementById('mermaidCode').addEventListener('input', () => {
            renderMermaid();
            saveToHash();
        });

        // 历史记录模态框事件绑定
        document.getElementById('closeHistory').addEventListener('click', hideHistoryModal);
        document.getElementById('clearAllHistory').addEventListener('click', clearAllHistory);
        
        document.getElementById('historyModal').addEventListener('click', function(e) {
            if (e.target === this) {
                hideHistoryModal();
            }
        });

        // 键盘快捷键 - 合并所有版本
        document.addEventListener('keydown', function(e) {
            const isFullscreen = document.getElementById('fullscreenModal').classList.contains('show');
            const isHistoryOpen = document.getElementById('historyModal').classList.contains('show');
            
            if (isFullscreen) {
                switch(e.key) {
                    case 'Escape':
                        e.preventDefault();
                        closeFullscreen();
                        break;
                    case '+':
                    case '=':
                        e.preventDefault();
                        zoomIn();
                        break;
                    case '-':
                        e.preventDefault();
                        zoomOut();
                        break;
                    case '0':
                        e.preventDefault();
                        resetZoom();
                        break;
                }
            } else if (isHistoryOpen) {
                if (e.key === 'Escape') {
                    e.preventDefault();
                    hideHistoryModal();
                }
            } else {
                if (e.ctrlKey || e.metaKey) {
                    switch(e.key) {
                        case 'Enter':
                            e.preventDefault();
                            renderMermaid();
                            break;
                        case 's':
                            e.preventDefault();
                            copyAsImage();
                            break;
                        case 'd':
                            e.preventDefault();
                            downloadImage();
                            break;
                        case 'f':
                            e.preventDefault();
                            openFullscreen();
                            break;
                        case 'h':
                            e.preventDefault();
                            showHistoryModal();
                            break;
                        case 'l':
                            e.preventDefault();
                            formatCode();
                            break;
                    }
                }
            }
        });

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadFromHash();
            renderMermaid();
        });
    </script>
</body>
</html>
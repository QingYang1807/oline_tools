<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>极简画板 - 专业绘图工具</title>
    <link rel="stylesheet" href="../../assets/css/style.css">
    <meta name="color-scheme" content="light dark">
    <style>
        :root { --bg:#f8fafc; --border:#e5e7eb; }


        /* 让分组更紧凑，边界更清晰 */
        .tool-group {
            padding: 4px 6px;              /* 原 6px，略紧凑 */
            border: 1px solid var(--border);
        }
        .tool-btn { color:#111827; }
        /* 图标更醒目，尺寸略放大一点 */
        .tool-btn svg {
            width: 22px;                   /* 原 20px */
            height: 22px;
        }

        @media (prefers-color-scheme: dark) {
            :root { --bg:#0b0f14; --border:#1f2937; }
        }

        /* 如果你希望顶栏整体提高对比度，也可以加这一条 */
        .top-toolbar { color:#111827; }
        @media (prefers-color-scheme: dark) {
            .top-toolbar { color:#e5e7eb; }
        }


        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
            background: var(--bg);
            overflow: hidden;
            height: 100vh;
            user-select: none;
        }

    .app-container {
      display: flex;
      height: 100vh;
      position: relative;
    }

    /* 顶部工具栏 */
    .top-toolbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      z-index: 1000;
    }
    
    @media (prefers-color-scheme: dark) {
      .top-toolbar {
        background: rgba(26, 26, 26, 0.95);
      }
    }

    .toolbar-left, .toolbar-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .tool-group {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px;
      background: #f1f5f9;
      border-radius: 12px;
    }

    .tool-btn {
      width: 40px;
      height: 40px;
      border: none;
      background: transparent;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      position: relative;
    }

    .tool-btn:hover {
      background: rgba(59, 130, 246, 0.1);
      transform: scale(1.05);
    }

    /* 激活态：蓝底白字 + 轻微描边，图标不会“糊”在底色里 */
    .tool-btn.active {
        background: #3b82f6;
        color: #fff;
        box-shadow: 0 0 0 1px rgba(255,255,255,.5) inset, 0 2px 8px rgba(59,130,246,.3);
    }

    .tool-btn svg {
      width: 20px;
      height: 20px;
    }

    /* 颜色选择器 */
    .color-picker-wrapper {
      position: relative;
    }

    .color-display {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      border: 2px solid #e2e8f0;
      cursor: pointer;
      background: #000;
      transition: transform 0.2s ease;
    }

    .color-display:hover {
      transform: scale(1.05);
    }

    .color-palette {
      position: absolute;
      top: 50px;
      left: 0;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
      padding: 16px;
      display: none;
      z-index: 1001;
      border: 1px solid #e2e8f0;
    }

    .color-palette.show {
      display: block;
    }

    .color-grid {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 8px;
      margin-bottom: 16px;
    }

    .color-option {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.2s ease;
    }

    .color-option:hover {
      transform: scale(1.1);
      border-color: #3b82f6;
    }

    .color-option.selected {
      border-color: #3b82f6;
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
    }

    .custom-color {
      width: 100%;
      height: 40px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      cursor: pointer;
    }

    /* 画笔大小滑块 */
    .brush-size-wrapper {
      display: flex;
      align-items: center;
      gap: 12px;
      background: #f1f5f9;
      padding: 8px 12px;
      border-radius: 12px;
    }

    .brush-size-slider {
      width: 100px;
      height: 6px;
      background: #e2e8f0;
      border-radius: 3px;
      outline: none;
      cursor: pointer;
      appearance: none;
    }

    .brush-size-slider::-webkit-slider-thumb {
      appearance: none;
      width: 18px;
      height: 18px;
      background: #3b82f6;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }

    .brush-preview {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: #000;
      transition: all 0.2s ease;
    }

    /* 画布容器 */
    .canvas-container {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 80px 20px 20px;
      background: #f8fafc;
    }

    #canvas {
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
      cursor: crosshair;
      touch-action: none;
      max-width: 100%;
      max-height: 100%;
    }

    /* 快捷操作按钮 */
    .quick-actions {
      position: fixed;
      bottom: 20px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      z-index: 1000;
    }

    .quick-btn {
      width: 56px;
      height: 56px;
      border: 1px solid #e5e7eb;       /* 边框增强可见性 */
      border-radius: 16px;
      background: white;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      color: #111827;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .quick-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
    }

    .quick-btn.danger:hover {
      background: #ef4444;
      color: white;
    }

        .quick-btn svg { color: currentColor; }

    /* 工具提示 */
    .tooltip {
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease;
      margin-bottom: 8px;
    }

    .tool-btn:hover .tooltip,
    .quick-btn:hover .tooltip {
      opacity: 1;
    }

    /* 形状工具菜单 */
    .shape-menu {
      position: absolute;
      top: 50px;
      left: 0;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
      padding: 8px;
      display: none;
      z-index: 1001;
      border: 1px solid #e2e8f0;
    }

    .shape-menu.show {
      display: flex;
      gap: 4px;
    }

    .shape-option {
      width: 40px;
      height: 40px;
      border: none;
      background: transparent;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .shape-option:hover {
      background: #f1f5f9;
    }

    .shape-option.active {
      background: #3b82f6;
      color: white;
    }

    /* 导出菜单 */
    .export-menu {
      position: absolute;
      top: 50px;
      right: 0;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
      padding: 12px;
      display: none;
      z-index: 1001;
      border: 1px solid #e2e8f0;
      min-width: 160px;
    }

    .export-menu.show {
      display: block;
    }

    .export-option {
      width: 100%;
      padding: 10px 16px;
      border: none;
      background: transparent;
      text-align: left;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 14px;
      color: #374151;
    }

    .export-option:hover {
      background: #f1f5f9;
      color: #3b82f6;
    }

    /* 文字输入框 */
    .text-input {
      position: absolute;
      border: 2px dashed #3b82f6;
      background: rgba(255, 255, 255, 0.95);
      padding: 8px 12px;
      font-family: inherit;
      font-size: 16px;
      outline: none;
      border-radius: 8px;
      min-width: 120px;
      display: none;
      z-index: 1002;
    }

    .text-input.show {
      display: block;
    }

    /* 移动端适配 */
    @media (max-width: 768px) {
      .top-toolbar {
        padding: 0 12px;
        height: 56px;
      }

      .toolbar-left, .toolbar-right {
        gap: 8px;
      }

      .tool-group {
        gap: 4px;
        padding: 4px;
      }

      .tool-btn {
        width: 36px;
        height: 36px;
      }

      .brush-size-wrapper {
        padding: 6px 8px;
      }

      .brush-size-slider {
        width: 60px;
      }

      .canvas-container {
        padding: 70px 10px 10px;
      }

      .quick-actions {
        bottom: 16px;
        right: 16px;
      }

      .quick-btn {
        width: 48px;
        height: 48px;
      }

      .color-palette {
        left: -50px;
      }

      .color-grid {
        grid-template-columns: repeat(6, 1fr);
      }
    }

    /* 成功提示 */
    .toast {
      position: fixed;
      top: 80px;
      right: 20px;
      background: #10b981;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      transform: translateX(100%);
      transition: transform 0.3s ease;
      z-index: 1003;
    }

    .toast.show {
      transform: translateX(0);
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- 顶部工具栏 -->
    <div class="top-toolbar">
      <div class="toolbar-left">
        <!-- 绘图工具 -->
        <div class="tool-group">
          <button class="tool-btn active" data-tool="pen" title="画笔 (P)">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
            </svg>
            <div class="tooltip">画笔 (P)</div>
          </button>
          
          <button class="tool-btn" data-tool="eraser" title="橡皮擦 (E)">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M16.24 3.56l4.95 4.94c.78.79.78 2.05 0 2.84L12 20.53a4.008 4.008 0 0 1-5.66 0L2.81 17c-.78-.79-.78-2.05 0-2.84l8.48-8.48c.79-.78 2.05-.78 2.84 0l2.11 2.12zm-4.95 11.31c.39.39 1.02.39 1.41 0l5.66-5.66c.39-.39.39-1.02 0-1.41L16.24 5.68c-.39-.39-1.02-.39-1.41 0L9.17 11.31c-.39.39-.39 1.02 0 1.41l2.12 2.15z"/>
            </svg>
            <div class="tooltip">橡皮擦 (E)</div>
          </button>

          <div class="shape-tool-wrapper" style="position: relative;">
            <button class="tool-btn" data-tool="shapes" title="形状工具 (S)">
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14z"/>
              </svg>
              <div class="tooltip">形状工具 (S)</div>
            </button>
            <div class="shape-menu" id="shapeMenu">
              <button class="shape-option" data-shape="rectangle" title="矩形">
                <svg viewBox="0 0 24 24" fill="currentColor">
                  <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14z"/>
                </svg>
              </button>
              <button class="shape-option" data-shape="circle" title="圆形">
                <svg viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/>
                </svg>
              </button>
              <button class="shape-option" data-shape="line" title="直线">
                <svg viewBox="0 0 24 24" fill="currentColor">
                  <path d="M21.71 3.29c-.39-.39-1.02-.39-1.41 0L3.29 20.29c-.39.39-.39 1.02 0 1.41.39.39 1.02.39 1.41 0L21.71 4.71c.39-.39.39-1.02 0-1.42z"/>
                </svg>
              </button>
              <button class="shape-option" data-shape="arrow" title="箭头">
                <svg viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 4l-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8z"/>
                </svg>
              </button>
            </div>
          </div>

          <button class="tool-btn" data-tool="text" title="文字工具 (T)">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M5 4v3h5.5v12h3V7H19V4z"/>
            </svg>
            <div class="tooltip">文字工具 (T)</div>
          </button>
        </div>

        <!-- 颜色和画笔 -->
        <div class="color-picker-wrapper">
          <div class="color-display" id="colorDisplay"></div>
          <div class="color-palette" id="colorPalette">
            <div class="color-grid" id="colorGrid">
              <!-- 预设颜色将通过 JavaScript 生成 -->
            </div>
            <input type="color" class="custom-color" id="customColor" value="#000000">
          </div>
        </div>

        <div class="brush-size-wrapper">
          <input type="range" class="brush-size-slider" id="brushSize" min="1" max="50" value="3">
          <div class="brush-preview" id="brushPreview"></div>
        </div>
      </div>

      <div class="toolbar-right">
        <div class="tool-group">
          <button class="tool-btn" id="undoBtn" title="撤销 (Ctrl+Z)">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M12.5 8c-2.65 0-5.05.99-6.9 2.6L2 7v9h9l-3.62-3.62c1.39-1.16 3.16-1.88 5.12-1.88 3.54 0 6.55 2.31 7.6 5.5l2.37-.78C21.08 11.03 17.15 8 12.5 8z"/>
            </svg>
            <div class="tooltip">撤销 (Ctrl+Z)</div>
          </button>

          <button class="tool-btn" id="redoBtn" title="重做 (Ctrl+Y)">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M18.4 10.6C16.55 8.99 14.15 8 11.5 8c-4.65 0-8.58 3.03-9.96 7.22L3.9 16c1.05-3.19 4.05-5.5 7.6-5.5 1.95 0 3.73.72 5.12 1.88L19 16V7l-3.6 3.6z"/>
            </svg>
            <div class="tooltip">重做 (Ctrl+Y)</div>
          </button>
        </div>

        <div class="export-wrapper" style="position: relative;">
          <button class="tool-btn" data-tool="export" title="导出">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
            </svg>
            <div class="tooltip">导出</div>
          </button>
          <div class="export-menu" id="exportMenu">
            <button class="export-option" onclick="exportCanvas('png')">导出为 PNG</button>
            <button class="export-option" onclick="exportCanvas('jpg')">导出为 JPG</button>
            <button class="export-option" onclick="saveProject()">保存项目</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 画布容器 -->
    <div class="canvas-container">
      <canvas id="canvas" width="1200" height="800"></canvas>
    </div>

    <!-- 快捷操作按钮 -->
    <div class="quick-actions">
      <button class="quick-btn danger" id="clearBtn" title="清空画布">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
        </svg>
        <div class="tooltip">清空画布</div>
      </button>

      <button class="quick-btn" id="zoomInBtn" title="放大">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
          <path d="M12 10h-2v2H9v-2H7V9h2V7h1v2h2v1z"/>
        </svg>
        <div class="tooltip">放大</div>
      </button>

      <button class="quick-btn" id="zoomOutBtn" title="缩小">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
          <path d="M7 9v1h5V9H7z"/>
        </svg>
        <div class="tooltip">缩小</div>
      </button>

      <button class="quick-btn" id="fitToScreenBtn" title="适应屏幕">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/>
        </svg>
        <div class="tooltip">适应屏幕</div>
      </button>
    </div>

    <!-- 文字输入框 -->
    <input type="text" class="text-input" id="textInput" placeholder="输入文字...">

    <!-- 成功提示 -->
    <div class="toast" id="toast"></div>
  </div>

  <script>
    class ModernWhiteboard {
      constructor() {
        this.canvas = document.getElementById('canvas');
        this.ctx = this.canvas.getContext('2d');
        
        // 状态管理
        this.currentTool = 'pen';
        this.currentColor = '#000000';
        this.currentSize = 3;
        this.currentShape = 'rectangle';
        
        // 绘图状态
        this.isDrawing = false;
        this.startX = 0;
        this.startY = 0;
        this.lastX = 0;
        this.lastY = 0;
        
        // 历史记录
        this.history = [];
        this.historyIndex = -1;
        this.maxHistory = 50;
        
        // 缩放和平移
        this.scale = 1;
        this.offsetX = 0;
        this.offsetY = 0;
        this.minScale = 0.1;
        this.maxScale = 5;
        
        // 预设颜色
        this.presetColors = [
          '#000000', '#FFFFFF', '#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#FF00FF', '#00FFFF',
          '#800000', '#008000', '#000080', '#808000', '#800080', '#008080', '#C0C0C0', '#808080',
          '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8', '#F7DC6F',
          '#BB8FCE', '#85C1E9', '#F8C471', '#82E0AA', '#F1948A', '#AED6F1', '#F9E79F', '#A9DFBF'
        ];
        
        this.init();
      }
      
      init() {
        this.setupCanvas();
        this.setupEventListeners();
        this.setupColorPalette();
        this.saveState();
        this.updateBrushPreview();
        
        // 显示欢迎提示
        this.showToast('画板已准备就绪！使用快捷键：P(画笔) E(橡皮) S(形状) T(文字)');
      }

      setupCanvas() {
        this.ctx.lineCap = 'round';
        this.ctx.lineJoin = 'round';
        this.ctx.imageSmoothingEnabled = true;
        this.ctx.imageSmoothingQuality = 'high';

        // 高DPI：用 dpr 缩放绘图坐标系，但鼠标坐标不再乘 dpr
        const dpr = window.devicePixelRatio || 1;

        // 用父容器尺寸（可见尺寸）作为基准，避免初次 rect 取到旧值
        const parentRect = this.canvas.parentElement.getBoundingClientRect();

        // CSS 尺寸（可视大小）
        this.canvas.style.width = parentRect.width + 'px';
        this.canvas.style.height = parentRect.height + 'px';

        // 实际像素尺寸（渲染缓冲区）
        this.canvas.width = Math.max(1, Math.floor(parentRect.width * dpr));
        this.canvas.height = Math.max(1, Math.floor(parentRect.height * dpr));

        // 将坐标系缩放到 CSS 像素：之后所有绘制用“CSS像素”即可
        this.ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      }
      
      setupColorPalette() {
        const colorGrid = document.getElementById('colorGrid');
        const colorDisplay = document.getElementById('colorDisplay');
        
        // 生成预设颜色
        this.presetColors.forEach(color => {
          const colorOption = document.createElement('div');
          colorOption.className = 'color-option';
          colorOption.style.backgroundColor = color;
          colorOption.dataset.color = color;
          
          if (color === this.currentColor) {
            colorOption.classList.add('selected');
          }
          
          colorOption.addEventListener('click', () => {
            this.setColor(color);
            this.updateColorDisplay();
          });
          
          colorGrid.appendChild(colorOption);
        });
        
        // 自定义颜色选择器
        document.getElementById('customColor').addEventListener('change', (e) => {
          this.setColor(e.target.value);
          this.updateColorDisplay();
        });
        
        this.updateColorDisplay();
      }
      
      setupEventListeners() {
        // 工具按钮
        document.querySelectorAll('[data-tool]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            this.setTool(e.currentTarget.dataset.tool);
          });
        });
        
        // 形状选择
        document.querySelectorAll('[data-shape]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            this.currentShape = e.currentTarget.dataset.shape;
            this.setTool('shapes');
            document.getElementById('shapeMenu').classList.remove('show');
          });
        });
        
        // 画笔大小
        document.getElementById('brushSize').addEventListener('input', (e) => {
          this.currentSize = parseInt(e.target.value);
          this.updateBrushPreview();
        });
        
        // 撤销重做
        document.getElementById('undoBtn').addEventListener('click', () => this.undo());
        document.getElementById('redoBtn').addEventListener('click', () => this.redo());
        
        // 清空画布
        document.getElementById('clearBtn').addEventListener('click', () => this.clearCanvas());
        
        // 缩放按钮
        document.getElementById('zoomInBtn').addEventListener('click', () => this.zoomIn());
        document.getElementById('zoomOutBtn').addEventListener('click', () => this.zoomOut());
        document.getElementById('fitToScreenBtn').addEventListener('click', () => this.fitToScreen());
        
        // 颜色面板切换
        document.getElementById('colorDisplay').addEventListener('click', () => {
          document.getElementById('colorPalette').classList.toggle('show');
        });
        
        // 画布事件
        this.canvas.addEventListener('mousedown', (e) => this.startDrawing(e));
        this.canvas.addEventListener('mousemove', (e) => this.draw(e));
        this.canvas.addEventListener('mouseup', () => this.stopDrawing());
        this.canvas.addEventListener('mouseout', () => this.stopDrawing());
        
        // 触摸事件
        this.canvas.addEventListener('touchstart', (e) => this.handleTouch(e, 'start'));
        this.canvas.addEventListener('touchmove', (e) => this.handleTouch(e, 'move'));
        this.canvas.addEventListener('touchend', (e) => this.handleTouch(e, 'end'));
        
        // 鼠标滚轮缩放
        this.canvas.addEventListener('wheel', (e) => this.handleWheel(e));
        
        // 键盘快捷键
        document.addEventListener('keydown', (e) => this.handleKeyboard(e));
        
        // 点击外部关闭菜单
        document.addEventListener('click', (e) => {
          if (!e.target.closest('.color-picker-wrapper')) {
            document.getElementById('colorPalette').classList.remove('show');
          }
          if (!e.target.closest('.shape-tool-wrapper')) {
            document.getElementById('shapeMenu').classList.remove('show');
          }
          if (!e.target.closest('.export-wrapper')) {
            document.getElementById('exportMenu').classList.remove('show');
          }
        });
        
        // 文字输入
        const textInput = document.getElementById('textInput');
        textInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            this.addText(textInput.value, this.textX, this.textY);
            textInput.classList.remove('show');
            textInput.value = '';
          } else if (e.key === 'Escape') {
            textInput.classList.remove('show');
            textInput.value = '';
          }
        });
      }
      
      setTool(tool) {
        // 移除所有活动状态
        document.querySelectorAll('.tool-btn').forEach(btn => {
          btn.classList.remove('active');
        });
        
        // 设置新工具
        this.currentTool = tool;
        
        // 添加活动状态
        const activeBtn = document.querySelector(`[data-tool="${tool}"]`);
        if (activeBtn) {
          activeBtn.classList.add('active');
        }
        
        // 特殊处理
        if (tool === 'shapes') {
          document.getElementById('shapeMenu').classList.toggle('show');
        } else if (tool === 'export') {
          document.getElementById('exportMenu').classList.toggle('show');
        }
        
        // 更新光标
        this.updateCursor();
      }
      
      setColor(color) {
        this.currentColor = color;
        
        // 更新选中状态
        document.querySelectorAll('.color-option').forEach(option => {
          option.classList.remove('selected');
          if (option.dataset.color === color) {
            option.classList.add('selected');
          }
        });
        
        this.updateBrushPreview();
      }
      
      updateColorDisplay() {
        document.getElementById('colorDisplay').style.backgroundColor = this.currentColor;
        document.getElementById('customColor').value = this.currentColor;
      }
      
      updateBrushPreview() {
        const preview = document.getElementById('brushPreview');
        preview.style.width = Math.max(4, this.currentSize) + 'px';
        preview.style.height = Math.max(4, this.currentSize) + 'px';
        preview.style.backgroundColor = this.currentColor;
      }
      
      updateCursor() {
        const cursors = {
          'pen': 'crosshair',
          'eraser': 'crosshair',
          'shapes': 'crosshair',
          'text': 'text'
        };
        
        this.canvas.style.cursor = cursors[this.currentTool] || 'default';
      }

      getEventPos(e) {
        const rect = this.canvas.getBoundingClientRect();

        // 使用 CSS 像素坐标；如果画布被 CSS scale 缩放，需要除以当前缩放因子
        const xCss = (e.clientX - rect.left) / this.scale;
        const yCss = (e.clientY - rect.top) / this.scale;

        return { x: xCss, y: yCss };
      }
      
      startDrawing(e) {
        const pos = this.getEventPos(e);
        
        this.isDrawing = true;
        this.startX = pos.x;
        this.startY = pos.y;
        this.lastX = pos.x;
        this.lastY = pos.y;
        
        if (this.currentTool === 'text') {
          this.showTextInput(e.clientX, e.clientY, pos.x, pos.y);
          return;
        }
        
        this.ctx.beginPath();
        this.ctx.moveTo(pos.x, pos.y);
        
        if (this.currentTool === 'pen') {
          this.ctx.strokeStyle = this.currentColor;
          this.ctx.lineWidth = this.currentSize;
          this.ctx.globalCompositeOperation = 'source-over';
        } else if (this.currentTool === 'eraser') {
          this.ctx.globalCompositeOperation = 'destination-out';
          this.ctx.lineWidth = this.currentSize * 2;
        }
      }
      
      draw(e) {
        if (!this.isDrawing) return;
        
        const pos = this.getEventPos(e);
        
        if (this.currentTool === 'pen' || this.currentTool === 'eraser') {
          this.ctx.lineTo(pos.x, pos.y);
          this.ctx.stroke();
          this.ctx.beginPath();
          this.ctx.moveTo(pos.x, pos.y);
        } else if (this.currentTool === 'shapes') {
          this.drawShapePreview(this.startX, this.startY, pos.x, pos.y);
        }
        
        this.lastX = pos.x;
        this.lastY = pos.y;
      }
      
      stopDrawing() {
        if (!this.isDrawing) return;
        
        this.isDrawing = false;
        
        if (this.currentTool === 'shapes') {
          this.drawShape(this.startX, this.startY, this.lastX, this.lastY);
        }
        
        this.saveState();
      }
      
      drawShape(startX, startY, endX, endY) {
        this.ctx.strokeStyle = this.currentColor;
        this.ctx.lineWidth = this.currentSize;
        this.ctx.globalCompositeOperation = 'source-over';
        
        this.ctx.beginPath();
        
        switch (this.currentShape) {
          case 'rectangle':
            this.ctx.rect(startX, startY, endX - startX, endY - startY);
            break;
          case 'circle':
            const radius = Math.sqrt(Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2));
            this.ctx.arc(startX, startY, radius, 0, 2 * Math.PI);
            break;
          case 'line':
            this.ctx.moveTo(startX, startY);
            this.ctx.lineTo(endX, endY);
            break;
          case 'arrow':
            this.drawArrow(startX, startY, endX, endY);
            break;
        }
        
        this.ctx.stroke();
      }
      
      drawShapePreview(startX, startY, endX, endY) {
        // 清除画布并重绘历史
        this.restoreState();
        
        // 绘制预览
        this.ctx.save();
        this.ctx.strokeStyle = this.currentColor;
        this.ctx.lineWidth = this.currentSize;
        this.ctx.setLineDash([5, 5]);
        this.ctx.globalAlpha = 0.7;
        
        this.ctx.beginPath();
        
        switch (this.currentShape) {
          case 'rectangle':
            this.ctx.rect(startX, startY, endX - startX, endY - startY);
            break;
          case 'circle':
            const radius = Math.sqrt(Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2));
            this.ctx.arc(startX, startY, radius, 0, 2 * Math.PI);
            break;
          case 'line':
            this.ctx.moveTo(startX, startY);
            this.ctx.lineTo(endX, endY);
            break;
          case 'arrow':
            this.drawArrow(startX, startY, endX, endY);
            break;
        }
        
        this.ctx.stroke();
        this.ctx.restore();
      }
      
      drawArrow(startX, startY, endX, endY) {
        const headlen = 15;
        const angle = Math.atan2(endY - startY, endX - startX);
        
        // 绘制线条
        this.ctx.moveTo(startX, startY);
        this.ctx.lineTo(endX, endY);
        
        // 绘制箭头
        this.ctx.lineTo(endX - headlen * Math.cos(angle - Math.PI / 6), endY - headlen * Math.sin(angle - Math.PI / 6));
        this.ctx.moveTo(endX, endY);
        this.ctx.lineTo(endX - headlen * Math.cos(angle + Math.PI / 6), endY - headlen * Math.sin(angle + Math.PI / 6));
      }
      
      showTextInput(clientX, clientY, canvasX, canvasY) {
        const textInput = document.getElementById('textInput');
        textInput.style.left = clientX + 'px';
        textInput.style.top = clientY + 'px';
        textInput.classList.add('show');
        textInput.focus();
        
        this.textX = canvasX;
        this.textY = canvasY;
      }
      
      addText(text, x, y) {
        if (!text.trim()) return;
        
        this.ctx.font = `${this.currentSize * 8}px Arial`;
        this.ctx.fillStyle = this.currentColor;
        this.ctx.textBaseline = 'top';
        this.ctx.fillText(text, x, y);
        
        this.saveState();
      }
      
      handleTouch(e, type) {
        e.preventDefault();
        
        if (e.touches.length === 1) {
          const touch = e.touches[0];
          const mouseEvent = new MouseEvent(type === 'start' ? 'mousedown' : type === 'move' ? 'mousemove' : 'mouseup', {
            clientX: touch.clientX,
            clientY: touch.clientY
          });
          
          this.canvas.dispatchEvent(mouseEvent);
        }
      }

      handleWheel(e) {
        e.preventDefault();
        const delta = e.deltaY > 0 ? 0.9 : 1.1;
        this.scale = Math.max(this.minScale, Math.min(this.maxScale, this.scale * delta));
        this.canvas.style.transform = `scale(${this.scale})`;
        this.showToast(`缩放: ${Math.round(this.scale * 100)}%`);
      }
      
      handleKeyboard(e) {
        if (e.target.tagName === 'INPUT') return;
        
        if (e.ctrlKey || e.metaKey) {
          switch (e.key.toLowerCase()) {
            case 'z':
              e.preventDefault();
              if (e.shiftKey) {
                this.redo();
              } else {
                this.undo();
              }
              break;
            case 'y':
              e.preventDefault();
              this.redo();
              break;
            case 's':
              e.preventDefault();
              exportCanvas('png');
              break;
          }
        } else {
          switch (e.key.toLowerCase()) {
            case 'p':
              this.setTool('pen');
              break;
            case 'e':
              this.setTool('eraser');
              break;
            case 's':
              this.setTool('shapes');
              break;
            case 't':
              this.setTool('text');
              break;
          }
        }
      }
      
      saveState() {
        // 限制历史记录数量
        if (this.history.length > this.maxHistory) {
          this.history.shift();
          this.historyIndex--;
        }
        
        // 删除当前位置之后的历史记录
        this.history = this.history.slice(0, this.historyIndex + 1);
        
        // 保存当前状态
        this.history.push(this.canvas.toDataURL());
        this.historyIndex = this.history.length - 1;
      }
      
      restoreState() {
        if (this.historyIndex >= 0 && this.history[this.historyIndex]) {
          const img = new Image();
          img.onload = () => {
            this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
            this.ctx.drawImage(img, 0, 0);
          };
          img.src = this.history[this.historyIndex];
        }
      }
      
      undo() {
        if (this.historyIndex > 0) {
          this.historyIndex--;
          this.restoreState();
          this.showToast('已撤销');
        }
      }
      
      redo() {
        if (this.historyIndex < this.history.length - 1) {
          this.historyIndex++;
          this.restoreState();
          this.showToast('已重做');
        }
      }
      
      clearCanvas() {
        if (confirm('确定要清空画布吗？此操作无法撤销。')) {
          this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
          this.saveState();
          this.showToast('画布已清空');
        }
      }
      
      zoomIn() {
        this.scale = Math.min(this.maxScale, this.scale * 1.2);
        this.canvas.style.transform = `scale(${this.scale})`;
        this.showToast(`缩放: ${Math.round(this.scale * 100)}%`);
      }
      
      zoomOut() {
        this.scale = Math.max(this.minScale, this.scale * 0.8);
        this.canvas.style.transform = `scale(${this.scale})`;
        this.showToast(`缩放: ${Math.round(this.scale * 100)}%`);
      }
      
      fitToScreen() {
        this.scale = 1;
        this.canvas.style.transform = 'scale(1)';
        this.showToast('已适应屏幕');
      }
      
      showToast(message) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.classList.add('show');
        
        setTimeout(() => {
          toast.classList.remove('show');
        }, 2000);
      }
    }
    
    // 导出功能
    function exportCanvas(format) {
      const canvas = document.getElementById('canvas');
      const link = document.createElement('a');
      const timestamp = new Date().toISOString().slice(0, 19).replace(/[:]/g, '-');
      
      switch (format) {
        case 'png':
          link.download = `drawing-${timestamp}.png`;
          link.href = canvas.toDataURL('image/png');
          break;
        case 'jpg':
          link.download = `drawing-${timestamp}.jpg`;
          link.href = canvas.toDataURL('image/jpeg', 0.9);
          break;
      }
      
      link.click();
      document.getElementById('exportMenu').classList.remove('show');
      whiteboard.showToast(`已导出为 ${format.toUpperCase()}`);
    }
    
    function saveProject() {
      const canvas = document.getElementById('canvas');
      const projectData = {
        image: canvas.toDataURL(),
        timestamp: new Date().toISOString(),
        version: '1.0'
      };
      
      const blob = new Blob([JSON.stringify(projectData)], { type: 'application/json' });
      const link = document.createElement('a');
      link.download = `drawing-project-${new Date().toISOString().slice(0, 19).replace(/[:]/g, '-')}.json`;
      link.href = URL.createObjectURL(blob);
      link.click();
      
      document.getElementById('exportMenu').classList.remove('show');
      whiteboard.showToast('项目已保存');
    }
    
    // 初始化画板
    let whiteboard;

    document.addEventListener('DOMContentLoaded', () => {
      whiteboard = new ModernWhiteboard();
    });
    
    // 窗口大小调整
    window.addEventListener('resize', () => {
      if (whiteboard) {
        const prev = whiteboard.historyIndex;
        whiteboard.setupCanvas();
        // 重新把当前历史帧画回去
        if (prev >= 0) whiteboard.restoreState();
      }
    });
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQLå›æ»šç”Ÿæˆå·¥å…·</title>
    <link rel="stylesheet" href="../../assets/css/style.css">
    <style>
        .sql-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .sql-panel {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px var(--shadow);
        }
        
        .sql-panel h3 {
            margin: 0 0 16px 0;
            color: var(--fg);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .sql-textarea {
            width: 100%;
            height: 300px;
            background: var(--panel-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            color: var(--fg);
            resize: vertical;
            line-height: 1.5;
        }
        
        .sql-textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }
        
        .config-section {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px var(--shadow);
        }
        
        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
        }
        
        .config-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .config-label {
            font-weight: 500;
            color: var(--fg);
            font-size: 14px;
        }
        
        .config-select, .config-input {
            padding: 10px 12px;
            background: var(--panel-bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--fg);
            font-size: 14px;
        }
        
        .config-select:focus, .config-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }
        
        .action-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: var(--accent);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: var(--panel-bg);
            color: var(--fg);
            border: 1px solid var(--border);
        }
        
        .btn-secondary:hover {
            background: var(--border);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 16px;
        }
        
        .status-info {
            background: rgba(59, 130, 246, 0.1);
            color: var(--accent);
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        
        .status-success {
            background: rgba(34, 197, 94, 0.1);
            color: #22c55e;
            border: 1px solid rgba(34, 197, 94, 0.2);
        }
        
        .status-error {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }
        
        .status-warning {
            background: rgba(245, 158, 11, 0.1);
            color: #f59e0b;
            border: 1px solid rgba(245, 158, 11, 0.2);
        }
        
        .loading-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .examples-section {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px var(--shadow);
        }
        
        .example-item {
            background: var(--panel-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .example-item:hover {
            border-color: var(--accent);
            background: rgba(59, 130, 246, 0.05);
        }
        
        .example-title {
            font-weight: 500;
            color: var(--fg);
            margin-bottom: 8px;
        }
        
        .example-sql {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            color: var(--muted);
            background: var(--card);
            padding: 8px;
            border-radius: 4px;
            border: 1px solid var(--border);
        }
        
        .help-section {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px var(--shadow);
        }
        
        .help-content {
            color: var(--muted);
            line-height: 1.6;
        }
        
        .help-content h4 {
            color: var(--fg);
            margin: 16px 0 8px 0;
        }
        
        .help-content ul {
            margin: 8px 0;
            padding-left: 20px;
        }
        
        .help-content li {
            margin-bottom: 4px;
        }
        
        @media (max-width: 768px) {
            .sql-container {
                grid-template-columns: 1fr;
            }
            
            .config-grid {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
        }
        
        .api-key-input {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 12px;
        }
        
        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 6px 12px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.2s ease;
        }
        
        .copy-btn:hover {
            opacity: 1;
        }
        
        .sql-panel {
            position: relative;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="page-header">
            <h1>ğŸ”„ SQLå›æ»šç”Ÿæˆå·¥å…·</h1>
            <p>è¾“å…¥SQLè¯­å¥ï¼Œè‡ªåŠ¨ç”Ÿæˆå¯¹åº”çš„å›æ»šSQLï¼Œæ”¯æŒå¤šç§æ•°æ®æºå’ŒAIæ¨¡å‹</p>
        </header>

        <!-- é…ç½®éƒ¨åˆ† -->
        <section class="config-section">
            <h3>âš™ï¸ é…ç½®é€‰é¡¹</h3>
            <div class="config-grid">
                <div class="config-group">
                    <label class="config-label">ç”Ÿæˆæ–¹å¼</label>
                    <select id="generationMode" class="config-select">
                        <option value="local">æœ¬åœ°CPUè®¡ç®—</option>
                        <option value="llm">LLMå¤§æ¨¡å‹</option>
                    </select>
                </div>
                
                <div class="config-group">
                    <label class="config-label">æ•°æ®åº“ç±»å‹</label>
                    <select id="databaseType" class="config-select">
                        <option value="mysql">MySQL</option>
                        <option value="postgresql">PostgreSQL</option>
                        <option value="sqlite">SQLite</option>
                        <option value="oracle">Oracle</option>
                        <option value="sqlserver">SQL Server</option>
                        <option value="mongodb">MongoDB</option>
                        <option value="redis">Redis</option>
                        <option value="elasticsearch">Elasticsearch</option>
                    </select>
                </div>
                
                <div class="config-group llm-config" style="display: none;">
                    <label class="config-label">LLMæä¾›å•†</label>
                    <select id="llmProvider" class="config-select">
                        <option value="openai">OpenAI</option>
                        <option value="claude">Anthropic Claude</option>
                        <option value="gemini">Google Gemini</option>
                        <option value="azure">Azure OpenAI</option>
                        <option value="custom">è‡ªå®šä¹‰API</option>
                    </select>
                </div>
                
                <div class="config-group llm-config" style="display: none;">
                    <label class="config-label">æ¨¡å‹é€‰æ‹©</label>
                    <select id="llmModel" class="config-select">
                        <option value="gpt-4">GPT-4</option>
                        <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                        <option value="claude-3-opus">Claude-3 Opus</option>
                        <option value="claude-3-sonnet">Claude-3 Sonnet</option>
                        <option value="gemini-pro">Gemini Pro</option>
                    </select>
                </div>
                
                <div class="config-group llm-config" style="display: none;">
                    <label class="config-label">API Key</label>
                    <input type="password" id="apiKey" class="config-input api-key-input" placeholder="è¾“å…¥æ‚¨çš„API Key">
                </div>
                
                <div class="config-group llm-config" style="display: none;">
                    <label class="config-label">è‡ªå®šä¹‰APIåœ°å€</label>
                    <input type="text" id="customApiUrl" class="config-input" placeholder="https://api.example.com/v1/chat/completions">
                </div>
            </div>
        </section>

        <!-- çŠ¶æ€æŒ‡ç¤ºå™¨ -->
        <div id="statusIndicator" class="status-indicator status-info" style="display: none;">
            <span id="statusIcon">â„¹ï¸</span>
            <span id="statusText">å°±ç»ª</span>
        </div>

        <!-- SQLè¾“å…¥å’Œè¾“å‡º -->
        <section class="sql-container">
            <div class="sql-panel">
                <h3>ğŸ“ åŸå§‹SQL</h3>
                <textarea id="originalSql" class="sql-textarea" placeholder="è¯·è¾“å…¥æ‚¨çš„SQLè¯­å¥...

ç¤ºä¾‹ï¼š
INSERT INTO users (id, name, email) VALUES (1, 'John Doe', 'john@example.com');
UPDATE users SET name = 'Jane Doe' WHERE id = 1;
DELETE FROM users WHERE id = 1;"></textarea>
            </div>
            
            <div class="sql-panel">
                <h3>ğŸ”„ å›æ»šSQL</h3>
                <button class="copy-btn" onclick="copyRollbackSql()" title="å¤åˆ¶å›æ»šSQL">å¤åˆ¶</button>
                <textarea id="rollbackSql" class="sql-textarea" placeholder="ç”Ÿæˆçš„å›æ»šSQLå°†åœ¨è¿™é‡Œæ˜¾ç¤º..." readonly></textarea>
            </div>
        </section>

        <!-- æ“ä½œæŒ‰é’® -->
        <div class="action-buttons">
            <button class="btn btn-primary" onclick="generateRollback()">
                <span id="generateIcon">ğŸš€</span>
                <span id="generateText">ç”Ÿæˆå›æ»šSQL</span>
            </button>
            <button class="btn btn-secondary" onclick="clearAll()">
                ğŸ—‘ï¸ æ¸…ç©º
            </button>
            <button class="btn btn-secondary" onclick="validateSql()">
                âœ… éªŒè¯SQL
            </button>
            <button class="btn btn-secondary" onclick="showExamples()">
                ğŸ“š ç¤ºä¾‹
            </button>
        </div>

        <!-- ç¤ºä¾‹éƒ¨åˆ† -->
        <section class="examples-section" id="examplesSection" style="display: none;">
            <h3>ğŸ“š SQLç¤ºä¾‹</h3>
            <div class="example-item" onclick="loadExample('insert')">
                <div class="example-title">INSERT æ’å…¥æ“ä½œ</div>
                <div class="example-sql">INSERT INTO users (id, name, email, created_at) VALUES (1, 'John Doe', 'john@example.com', '2024-01-01 10:00:00');</div>
            </div>
            
            <div class="example-item" onclick="loadExample('update')">
                <div class="example-title">UPDATE æ›´æ–°æ“ä½œ</div>
                <div class="example-sql">UPDATE users SET name = 'Jane Doe', email = 'jane@example.com' WHERE id = 1;</div>
            </div>
            
            <div class="example-item" onclick="loadExample('delete')">
                <div class="example-title">DELETE åˆ é™¤æ“ä½œ</div>
                <div class="example-sql">DELETE FROM users WHERE id = 1;</div>
            </div>
            
            <div class="example-item" onclick="loadExample('batch')">
                <div class="example-title">æ‰¹é‡æ“ä½œ</div>
                <div class="example-sql">INSERT INTO orders (id, user_id, amount, status) VALUES 
(1, 1, 99.99, 'pending'),
(2, 2, 149.99, 'completed'),
(3, 1, 79.99, 'cancelled');</div>
            </div>
        </section>

        <!-- å¸®åŠ©éƒ¨åˆ† -->
        <section class="help-section">
            <h3>ğŸ’¡ ä½¿ç”¨è¯´æ˜</h3>
            <div class="help-content">
                <h4>æ”¯æŒçš„æ“ä½œç±»å‹ï¼š</h4>
                <ul>
                    <li><strong>INSERT</strong>ï¼šç”Ÿæˆå¯¹åº”çš„DELETEè¯­å¥</li>
                    <li><strong>UPDATE</strong>ï¼šç”Ÿæˆæ¢å¤åŸå§‹å€¼çš„UPDATEè¯­å¥</li>
                    <li><strong>DELETE</strong>ï¼šç”Ÿæˆæ¢å¤åˆ é™¤è®°å½•çš„INSERTè¯­å¥</li>
                    <li><strong>CREATE TABLE</strong>ï¼šç”ŸæˆDROP TABLEè¯­å¥</li>
                    <li><strong>ALTER TABLE</strong>ï¼šç”Ÿæˆç›¸åçš„ALTERè¯­å¥</li>
                </ul>
                
                <h4>ç”Ÿæˆæ–¹å¼è¯´æ˜ï¼š</h4>
                <ul>
                    <li><strong>æœ¬åœ°CPUè®¡ç®—</strong>ï¼šåŸºäºSQLè¯­æ³•è§£æï¼Œå¿«é€Ÿç”Ÿæˆï¼Œæ— éœ€ç½‘ç»œ</li>
                    <li><strong>LLMå¤§æ¨¡å‹</strong>ï¼šä½¿ç”¨AIæ¨¡å‹ç†è§£å¤æ‚SQLï¼Œæ”¯æŒæ›´å¤šåœºæ™¯</li>
                </ul>
                
                <h4>æ•°æ®åº“æ”¯æŒï¼š</h4>
                <ul>
                    <li><strong>å…³ç³»å‹æ•°æ®åº“</strong>ï¼šMySQL, PostgreSQL, SQLite, Oracle, SQL Server</li>
                    <li><strong>NoSQLæ•°æ®åº“</strong>ï¼šMongoDB, Redis, Elasticsearch</li>
                </ul>
                
                <h4>æ³¨æ„äº‹é¡¹ï¼š</h4>
                <ul>
                    <li>ç”Ÿæˆçš„å›æ»šSQLä»…ä¾›å‚è€ƒï¼Œè¯·åœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯åä½¿ç”¨</li>
                    <li>å¯¹äºUPDATEå’ŒDELETEæ“ä½œï¼Œå»ºè®®å…ˆå¤‡ä»½ç›¸å…³æ•°æ®</li>
                    <li>API Keyä»…ä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨ï¼Œä¸ä¼šä¸Šä¼ åˆ°æœåŠ¡å™¨</li>
                    <li>å¤æ‚çš„å­˜å‚¨è¿‡ç¨‹å’Œè§¦å‘å™¨å¯èƒ½éœ€è¦æ‰‹åŠ¨å¤„ç†</li>
                </ul>
            </div>
        </section>
    </div>

    <script>
        // é…ç½®ç®¡ç†
        class ConfigManager {
            constructor() {
                this.config = this.loadConfig();
                this.initEventListeners();
            }
            
            loadConfig() {
                const saved = localStorage.getItem('sql-rollback-config');
                return saved ? JSON.parse(saved) : {
                    generationMode: 'local',
                    databaseType: 'mysql',
                    llmProvider: 'openai',
                    llmModel: 'gpt-3.5-turbo',
                    apiKey: '',
                    customApiUrl: ''
                };
            }
            
            saveConfig() {
                localStorage.setItem('sql-rollback-config', JSON.stringify(this.config));
            }
            
            initEventListeners() {
                const elements = ['generationMode', 'databaseType', 'llmProvider', 'llmModel', 'apiKey', 'customApiUrl'];
                elements.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.value = this.config[id] || '';
                        element.addEventListener('change', () => {
                            this.config[id] = element.value;
                            this.saveConfig();
                            this.updateUI();
                        });
                    }
                });
                
                this.updateUI();
            }
            
            updateUI() {
                const llmConfigs = document.querySelectorAll('.llm-config');
                const isLLMMode = this.config.generationMode === 'llm';
                
                llmConfigs.forEach(config => {
                    config.style.display = isLLMMode ? 'flex' : 'none';
                });
                
                // æ›´æ–°æ¨¡å‹é€‰é¡¹
                this.updateModelOptions();
            }
            
            updateModelOptions() {
                const modelSelect = document.getElementById('llmModel');
                const provider = this.config.llmProvider;
                
                const modelOptions = {
                    openai: [
                        { value: 'gpt-4', text: 'GPT-4' },
                        { value: 'gpt-3.5-turbo', text: 'GPT-3.5 Turbo' }
                    ],
                    claude: [
                        { value: 'claude-3-opus-20240229', text: 'Claude-3 Opus' },
                        { value: 'claude-3-sonnet-20240229', text: 'Claude-3 Sonnet' },
                        { value: 'claude-3-haiku-20240307', text: 'Claude-3 Haiku' }
                    ],
                    gemini: [
                        { value: 'gemini-pro', text: 'Gemini Pro' },
                        { value: 'gemini-pro-vision', text: 'Gemini Pro Vision' }
                    ],
                    azure: [
                        { value: 'gpt-4', text: 'GPT-4' },
                        { value: 'gpt-35-turbo', text: 'GPT-3.5 Turbo' }
                    ],
                    custom: [
                        { value: 'custom-model', text: 'è‡ªå®šä¹‰æ¨¡å‹' }
                    ]
                };
                
                modelSelect.innerHTML = '';
                (modelOptions[provider] || []).forEach(option => {
                    const optionElement = document.createElement('option');
                    optionElement.value = option.value;
                    optionElement.textContent = option.text;
                    modelSelect.appendChild(optionElement);
                });
                
                if (modelSelect.options.length > 0) {
                    modelSelect.value = modelSelect.options[0].value;
                    this.config.llmModel = modelSelect.value;
                    this.saveConfig();
                }
            }
        }
        
        // SQLè§£æå™¨
        class SQLParser {
            constructor(databaseType) {
                this.databaseType = databaseType;
            }
            
            parse(sql) {
                const trimmedSql = sql.trim();
                const upperSql = trimmedSql.toUpperCase();
                
                if (upperSql.startsWith('INSERT')) {
                    return this.parseInsert(trimmedSql);
                } else if (upperSql.startsWith('UPDATE')) {
                    return this.parseUpdate(trimmedSql);
                } else if (upperSql.startsWith('DELETE')) {
                    return this.parseDelete(trimmedSql);
                } else if (upperSql.startsWith('CREATE TABLE')) {
                    return this.parseCreateTable(trimmedSql);
                } else if (upperSql.startsWith('ALTER TABLE')) {
                    return this.parseAlterTable(trimmedSql);
                } else {
                    throw new Error('ä¸æ”¯æŒçš„SQLæ“ä½œç±»å‹');
                }
            }
            
            parseInsert(sql) {
                // è§£æINSERTè¯­å¥
                const match = sql.match(/INSERT\s+INTO\s+(\w+)\s*\(([^)]+)\)\s*VALUES\s*\((.+)\)/i);
                if (!match) {
                    throw new Error('æ— æ³•è§£æINSERTè¯­å¥');
                }
                
                const table = match[1];
                const columns = match[2].split(',').map(col => col.trim());
                const values = this.parseValues(match[3]);
                
                return {
                    type: 'INSERT',
                    table,
                    columns,
                    values
                };
            }
            
            parseUpdate(sql) {
                // è§£æUPDATEè¯­å¥
                const match = sql.match(/UPDATE\s+(\w+)\s+SET\s+(.+?)\s+WHERE\s+(.+)/i);
                if (!match) {
                    throw new Error('æ— æ³•è§£æUPDATEè¯­å¥ï¼Œç¼ºå°‘WHEREæ¡ä»¶');
                }
                
                const table = match[1];
                const setClause = match[2];
                const whereClause = match[3];
                
                const updates = this.parseSetClause(setClause);
                
                return {
                    type: 'UPDATE',
                    table,
                    updates,
                    where: whereClause
                };
            }
            
            parseDelete(sql) {
                // è§£æDELETEè¯­å¥
                const match = sql.match(/DELETE\s+FROM\s+(\w+)\s+WHERE\s+(.+)/i);
                if (!match) {
                    throw new Error('æ— æ³•è§£æDELETEè¯­å¥ï¼Œç¼ºå°‘WHEREæ¡ä»¶');
                }
                
                return {
                    type: 'DELETE',
                    table: match[1],
                    where: match[2]
                };
            }
            
            parseCreateTable(sql) {
                const match = sql.match(/CREATE\s+TABLE\s+(\w+)/i);
                if (!match) {
                    throw new Error('æ— æ³•è§£æCREATE TABLEè¯­å¥');
                }
                
                return {
                    type: 'CREATE_TABLE',
                    table: match[1]
                };
            }
            
            parseAlterTable(sql) {
                const match = sql.match(/ALTER\s+TABLE\s+(\w+)\s+(.+)/i);
                if (!match) {
                    throw new Error('æ— æ³•è§£æALTER TABLEè¯­å¥');
                }
                
                return {
                    type: 'ALTER_TABLE',
                    table: match[1],
                    operation: match[2]
                };
            }
            
            parseValues(valuesStr) {
                // ç®€å•çš„å€¼è§£æï¼Œæ”¯æŒåŸºæœ¬çš„æ•°æ®ç±»å‹
                return valuesStr.split(',').map(value => {
                    value = value.trim();
                    if (value.startsWith("'") && value.endsWith("'")) {
                        return value.slice(1, -1); // ç§»é™¤å¼•å·
                    }
                    return value;
                });
            }
            
            parseSetClause(setClause) {
                const updates = {};
                const pairs = setClause.split(',');
                
                pairs.forEach(pair => {
                    const [column, value] = pair.split('=').map(s => s.trim());
                    updates[column] = value.startsWith("'") && value.endsWith("'") 
                        ? value.slice(1, -1) 
                        : value;
                });
                
                return updates;
            }
        }
        
        // å›æ»šç”Ÿæˆå™¨
        class RollbackGenerator {
            constructor(databaseType) {
                this.databaseType = databaseType;
                this.parser = new SQLParser(databaseType);
            }
            
            async generate(sql, mode = 'local') {
                if (mode === 'llm') {
                    return await this.generateWithLLM(sql);
                } else {
                    return this.generateLocally(sql);
                }
            }
            
            generateLocally(sql) {
                try {
                    const parsed = this.parser.parse(sql);
                    
                    switch (parsed.type) {
                        case 'INSERT':
                            return this.generateDeleteRollback(parsed);
                        case 'UPDATE':
                            return this.generateUpdateRollback(parsed);
                        case 'DELETE':
                            return this.generateInsertRollback(parsed);
                        case 'CREATE_TABLE':
                            return `DROP TABLE IF EXISTS ${parsed.table};`;
                        case 'ALTER_TABLE':
                            return this.generateAlterRollback(parsed);
                        default:
                            throw new Error('ä¸æ”¯æŒçš„æ“ä½œç±»å‹');
                    }
                } catch (error) {
                    throw new Error(`æœ¬åœ°è§£æå¤±è´¥: ${error.message}`);
                }
            }
            
            generateDeleteRollback(parsed) {
                const { table, columns, values } = parsed;
                const whereConditions = [];
                
                columns.forEach((col, index) => {
                    const value = values[index];
                    if (typeof value === 'string') {
                        whereConditions.push(`${col} = '${value}'`);
                    } else {
                        whereConditions.push(`${col} = ${value}`);
                    }
                });
                
                return `DELETE FROM ${table} WHERE ${whereConditions.join(' AND ')};`;
            }
            
            generateUpdateRollback(parsed) {
                const { table, where } = parsed;
                
                // æ³¨æ„ï¼šè¿™é‡Œéœ€è¦åŸå§‹æ•°æ®æ‰èƒ½ç”Ÿæˆå‡†ç¡®çš„å›æ»šSQL
                // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œåº”è¯¥å…ˆæŸ¥è¯¢åŸå§‹æ•°æ®
                return `-- æ³¨æ„ï¼šéœ€è¦å…ˆæŸ¥è¯¢åŸå§‹æ•°æ®
-- SELECT * FROM ${table} WHERE ${where};
-- ç„¶åæ ¹æ®æŸ¥è¯¢ç»“æœç”ŸæˆUPDATEè¯­å¥æ¢å¤åŸå§‹å€¼
UPDATE ${table} SET /* åŸå§‹å­—æ®µå€¼ */ WHERE ${where};`;
            }
            
            generateInsertRollback(parsed) {
                const { table, where } = parsed;
                
                // æ³¨æ„ï¼šè¿™é‡Œéœ€è¦åŸå§‹æ•°æ®æ‰èƒ½ç”Ÿæˆå‡†ç¡®çš„å›æ»šSQL
                return `-- æ³¨æ„ï¼šéœ€è¦å…ˆå¤‡ä»½è¦åˆ é™¤çš„æ•°æ®
-- SELECT * FROM ${table} WHERE ${where};
-- ç„¶åæ ¹æ®å¤‡ä»½æ•°æ®ç”ŸæˆINSERTè¯­å¥
INSERT INTO ${table} (/* æ‰€æœ‰åˆ— */) VALUES (/* å¤‡ä»½çš„æ•°æ® */);`;
            }
            
            generateAlterRollback(parsed) {
                const { table, operation } = parsed;
                
                // ç®€å•çš„ALTERæ“ä½œå›æ»š
                if (operation.toUpperCase().includes('ADD COLUMN')) {
                    const columnMatch = operation.match(/ADD\s+COLUMN\s+(\w+)/i);
                    if (columnMatch) {
                        return `ALTER TABLE ${table} DROP COLUMN ${columnMatch[1]};`;
                    }
                } else if (operation.toUpperCase().includes('DROP COLUMN')) {
                    return `-- æ³¨æ„ï¼šDROP COLUMNæ“ä½œæ— æ³•å®Œå…¨å›æ»šï¼Œéœ€è¦æ‰‹åŠ¨é‡æ–°åˆ›å»ºåˆ—å’Œæ•°æ®`;
                }
                
                return `-- å¤æ‚çš„ALTERæ“ä½œéœ€è¦æ‰‹åŠ¨åˆ†æå’Œå›æ»š`;
            }
            
            async generateWithLLM(sql) {
                const config = configManager.config;
                
                if (!config.apiKey && config.llmProvider !== 'custom') {
                    throw new Error('è¯·å…ˆé…ç½®API Key');
                }
                
                const prompt = this.buildPrompt(sql, config.databaseType);
                
                try {
                    const response = await this.callLLMAPI(prompt, config);
                    return this.extractSQLFromResponse(response);
                } catch (error) {
                    throw new Error(`LLMè°ƒç”¨å¤±è´¥: ${error.message}`);
                }
            }
            
            buildPrompt(sql, databaseType) {
                return `è¯·ä¸ºä»¥ä¸‹${databaseType}æ•°æ®åº“çš„SQLè¯­å¥ç”Ÿæˆå¯¹åº”çš„å›æ»šSQLã€‚

åŸå§‹SQL:
${sql}

è¦æ±‚ï¼š
1. ç”Ÿæˆçš„å›æ»šSQLåº”è¯¥èƒ½å¤Ÿæ’¤é”€åŸå§‹SQLçš„æ“ä½œ
2. å¯¹äºUPDATEå’ŒDELETEæ“ä½œï¼Œè¯·æ³¨æ„éœ€è¦å…ˆå¤‡ä»½åŸå§‹æ•°æ®
3. åªè¿”å›å›æ»šSQLè¯­å¥ï¼Œä¸è¦åŒ…å«å…¶ä»–è§£é‡Š
4. å¦‚æœæ— æ³•ç”Ÿæˆå‡†ç¡®çš„å›æ»šSQLï¼Œè¯·è¯´æ˜åŸå› å’Œå»ºè®®

å›æ»šSQL:`;
            }
            
            async callLLMAPI(prompt, config) {
                const { llmProvider, llmModel, apiKey, customApiUrl } = config;
                
                let url, headers, body;
                
                switch (llmProvider) {
                    case 'openai':
                        url = 'https://api.openai.com/v1/chat/completions';
                        headers = {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        };
                        body = {
                            model: llmModel,
                            messages: [{ role: 'user', content: prompt }],
                            max_tokens: 1000,
                            temperature: 0.1
                        };
                        break;
                        
                    case 'claude':
                        url = 'https://api.anthropic.com/v1/messages';
                        headers = {
                            'Content-Type': 'application/json',
                            'x-api-key': apiKey,
                            'anthropic-version': '2023-06-01'
                        };
                        body = {
                            model: llmModel,
                            max_tokens: 1000,
                            messages: [{ role: 'user', content: prompt }]
                        };
                        break;
                        
                    case 'gemini':
                        url = `https://generativelanguage.googleapis.com/v1beta/models/${llmModel}:generateContent?key=${apiKey}`;
                        headers = {
                            'Content-Type': 'application/json'
                        };
                        body = {
                            contents: [{ parts: [{ text: prompt }] }],
                            generationConfig: {
                                temperature: 0.1,
                                maxOutputTokens: 1000
                            }
                        };
                        break;
                        
                    case 'custom':
                        url = customApiUrl;
                        headers = {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        };
                        body = {
                            model: llmModel,
                            messages: [{ role: 'user', content: prompt }],
                            max_tokens: 1000
                        };
                        break;
                        
                    default:
                        throw new Error('ä¸æ”¯æŒçš„LLMæä¾›å•†');
                }
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify(body)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                return await response.json();
            }
            
            extractSQLFromResponse(response) {
                const { llmProvider } = configManager.config;
                
                let content;
                
                switch (llmProvider) {
                    case 'openai':
                    case 'azure':
                    case 'custom':
                        content = response.choices?.[0]?.message?.content;
                        break;
                    case 'claude':
                        content = response.content?.[0]?.text;
                        break;
                    case 'gemini':
                        content = response.candidates?.[0]?.content?.parts?.[0]?.text;
                        break;
                    default:
                        throw new Error('æ— æ³•è§£æå“åº”');
                }
                
                if (!content) {
                    throw new Error('LLMè¿”å›äº†ç©ºå“åº”');
                }
                
                return content.trim();
            }
        }
        
        // å…¨å±€å˜é‡
        let configManager;
        let rollbackGenerator;
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            configManager = new ConfigManager();
            rollbackGenerator = new RollbackGenerator(configManager.config.databaseType);
            
            // ç›‘å¬æ•°æ®åº“ç±»å‹å˜åŒ–
            document.getElementById('databaseType').addEventListener('change', function() {
                rollbackGenerator = new RollbackGenerator(this.value);
            });
        });
        
        // ä¸»è¦åŠŸèƒ½å‡½æ•°
        async function generateRollback() {
            const originalSql = document.getElementById('originalSql').value.trim();
            
            if (!originalSql) {
                showStatus('warning', 'âš ï¸', 'è¯·è¾“å…¥SQLè¯­å¥');
                return;
            }
            
            const generateBtn = document.querySelector('.btn-primary');
            const generateIcon = document.getElementById('generateIcon');
            const generateText = document.getElementById('generateText');
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            generateBtn.disabled = true;
            generateIcon.innerHTML = '<div class="loading-spinner"></div>';
            generateText.textContent = 'ç”Ÿæˆä¸­...';
            showStatus('info', 'â³', 'æ­£åœ¨ç”Ÿæˆå›æ»šSQL...');
            
            try {
                const mode = configManager.config.generationMode;
                const rollbackSql = await rollbackGenerator.generate(originalSql, mode);
                
                document.getElementById('rollbackSql').value = rollbackSql;
                showStatus('success', 'âœ…', 'å›æ»šSQLç”ŸæˆæˆåŠŸ');
                
            } catch (error) {
                console.error('ç”Ÿæˆå›æ»šSQLå¤±è´¥:', error);
                showStatus('error', 'âŒ', `ç”Ÿæˆå¤±è´¥: ${error.message}`);
                document.getElementById('rollbackSql').value = `-- ç”Ÿæˆå¤±è´¥: ${error.message}`;
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                generateBtn.disabled = false;
                generateIcon.textContent = 'ğŸš€';
                generateText.textContent = 'ç”Ÿæˆå›æ»šSQL';
            }
        }
        
        function clearAll() {
            document.getElementById('originalSql').value = '';
            document.getElementById('rollbackSql').value = '';
            hideStatus();
        }
        
        function validateSql() {
            const originalSql = document.getElementById('originalSql').value.trim();
            
            if (!originalSql) {
                showStatus('warning', 'âš ï¸', 'è¯·è¾“å…¥SQLè¯­å¥');
                return;
            }
            
            try {
                const parser = new SQLParser(configManager.config.databaseType);
                const parsed = parser.parse(originalSql);
                showStatus('success', 'âœ…', `SQLéªŒè¯é€šè¿‡ - æ“ä½œç±»å‹: ${parsed.type}`);
            } catch (error) {
                showStatus('error', 'âŒ', `SQLéªŒè¯å¤±è´¥: ${error.message}`);
            }
        }
        
        function showExamples() {
            const examplesSection = document.getElementById('examplesSection');
            examplesSection.style.display = examplesSection.style.display === 'none' ? 'block' : 'none';
        }
        
        function loadExample(type) {
            const examples = {
                insert: "INSERT INTO users (id, name, email, created_at) VALUES (1, 'John Doe', 'john@example.com', '2024-01-01 10:00:00');",
                update: "UPDATE users SET name = 'Jane Doe', email = 'jane@example.com' WHERE id = 1;",
                delete: "DELETE FROM users WHERE id = 1;",
                batch: `INSERT INTO orders (id, user_id, amount, status) VALUES 
(1, 1, 99.99, 'pending'),
(2, 2, 149.99, 'completed'),
(3, 1, 79.99, 'cancelled');`
            };
            
            document.getElementById('originalSql').value = examples[type] || '';
            document.getElementById('examplesSection').style.display = 'none';
        }
        
        function copyRollbackSql() {
            const rollbackSql = document.getElementById('rollbackSql').value;
            
            if (!rollbackSql || rollbackSql.trim() === '') {
                showStatus('warning', 'âš ï¸', 'æ²¡æœ‰å¯å¤åˆ¶çš„å›æ»šSQL');
                return;
            }
            
            navigator.clipboard.writeText(rollbackSql).then(() => {
                showStatus('success', 'âœ…', 'å›æ»šSQLå·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            }).catch(() => {
                // é™çº§å¤„ç†
                const textarea = document.createElement('textarea');
                textarea.value = rollbackSql;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showStatus('success', 'âœ…', 'å›æ»šSQLå·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            });
        }
        
        function showStatus(type, icon, text) {
            const statusIndicator = document.getElementById('statusIndicator');
            const statusIcon = document.getElementById('statusIcon');
            const statusText = document.getElementById('statusText');
            
            statusIndicator.className = `status-indicator status-${type}`;
            statusIcon.textContent = icon;
            statusText.textContent = text;
            statusIndicator.style.display = 'flex';
            
            // è‡ªåŠ¨éšè—æˆåŠŸå’Œè­¦å‘Šæ¶ˆæ¯
            if (type === 'success' || type === 'warning') {
                setTimeout(() => {
                    hideStatus();
                }, 3000);
            }
        }
        
        function hideStatus() {
            document.getElementById('statusIndicator').style.display = 'none';
        }
    </script>
</body>
</html>